<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairfield Stock Control System</title>
    
    <!-- JsBarcode for barcode generation -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, Timestamp, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCb4U_ym-isdWjB9vYEPgnS_m1apBgXxtQ",
            authDomain: "fairfield-stock-control.firebaseapp.com",
            projectId: "fairfield-stock-control",
            storageBucket: "fairfield-stock-control.firebasestorage.app",
            messagingSenderId: "290258377915",
            appId: "1:290258377915:web:888de79df63592ab041d9e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        console.log('‚úÖ Firebase initialized');

        // Make available globally
        window.db = db;
        window.auth = auth;
        window.firebaseModules = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, Timestamp, setDoc, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword };
        
        // Trigger app initialization
        window.initializeApp();
    </script>
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-red: #DC2626;
            --dark-bg: #1F2937;
            --gray-50: #E8EAED;
            --gray-100: #D1D5DB;
            --gray-200: #BCC1C7;
            --gray-300: #9CA3AF;
            --gray-400: #6B7280;
            --gray-500: #4B5563;
            --gray-600: #374151;
            --gray-700: #1F2937;
            --gray-800: #111827;
            --gray-900: #0A0F1A;
            --green-600: #047857;
            --green-700: #065F46;
            --orange-600: #B45309;
            --orange-700: #92400E;
            --red-700: #B91C1C;
            --red-900: #7F1D1D;
            --blue-700: #1E3A8A;
            --blue-800: #1E3A8A;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--gray-50);
            line-height: 1.5;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .w-full { width: 100%; }
        .min-h-screen { min-height: 100vh; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .ml-1 { margin-left: 0.25rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .border { border: 1px solid var(--gray-300); }
        .border-t { border-top: 1px solid var(--gray-300); }
        .border-l-4 { border-left: 4px solid; }
        .border-red-600 { border-left-color: var(--primary-red); }
        .border-green-600 { border-left-color: var(--green-600); }
        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: var(--gray-50); }
        .bg-gray-100 { background-color: var(--gray-100); }
        .bg-gray-800 { background-color: var(--gray-800); }
        .text-white { color: white; }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .text-gray-700 { color: var(--gray-700); }
        .text-gray-800 { color: var(--gray-800); }
        .overflow-y-auto { overflow-y: auto; }
        .flex-1 { flex: 1; }
        
        /* Buttons */
        .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background-color: var(--primary-red);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--red-700);
        }
        
        .btn-secondary {
            background-color: var(--dark-bg);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--gray-700);
        }
        
        .btn-success {
            background-color: var(--green-600);
            color: white;
        }
        
        .btn-success:hover {
            background-color: var(--green-700);
        }
        
        .btn-warning {
            background-color: var(--orange-600);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: var(--orange-700);
        }
        
        .btn-action {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }
        
        .btn-action-edit {
            background-color: var(--blue-700);
            color: white;
        }
        
        .btn-action-edit:hover {
            background-color: var(--blue-800);
        }
        
        .btn-action-delete {
            background-color: var(--primary-red);
            color: white;
        }
        
        .btn-action-delete:hover {
            background-color: var(--red-900);
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        /* Sidebar */
        .sidebar {
            background-color: var(--dark-bg);
            min-height: 100vh;
            color: white;
            width: 256px;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-700);
        }
        
        .sidebar-logo {
            max-width: 200px;
            max-height: 80px;
            margin-bottom: 1rem;
            display: block;
        }
        
        .nav {
            padding: 1rem;
        }
        
        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            border-radius: 0.25rem;
        }
        
        .nav-item:hover,
        .nav-item.active {
            background-color: var(--gray-700);
            border-left-color: var(--primary-red);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background-color: #FEF3C7;
            color: #92400E;
        }
        
        .status-transit {
            background-color: #DBEAFE;
            color: var(--blue-700);
        }
        
        .status-received {
            background-color: #D1FAE5;
            color: #065F46;
        }
        
        /* Role Badges */
        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .role-admin {
            background-color: #FEE2E2;
            color: var(--red-900);
        }
        
        .role-dispatch {
            background-color: #DBEAFE;
            color: var(--blue-700);
        }
        
        .role-receiver {
            background-color: #D1FAE5;
            color: #065F46;
        }
        
        .role-view-only {
            background-color: var(--gray-200);
            color: var(--gray-700);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 95%;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: var(--gray-100);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--gray-200);
        }
        
        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        tr:hover {
            background-color: var(--gray-50);
        }
        
        /* Forms */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        input[type="month"],
        select,
        textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 1rem;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-red);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Logo */
        .login-logo {
            max-width: 200px;
            max-height: 100px;
            margin-bottom: 2rem;
        }
        
        .logo-upload-area {
            width: 250px;
            height: 150px;
            border: 2px dashed var(--gray-300);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: var(--gray-50);
        }
        
        .logo-upload-area:hover {
            border-color: var(--primary-red);
            background-color: #FEE2E2;
        }
        
        .logo-upload-area img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Dashboard Stats */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0.75rem;
            padding: 1.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .stat-card.red {
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .stat-card.orange {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
        }
        
        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
        }
        
        @media (min-width: 768px) {
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .grid-4 {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom right, #111827, var(--gray-700));
        }
        
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 24rem;
        }
        
        @media (max-width: 480px) {
            .login-box {
                width: 90vw;
                padding: 1.5rem;
            }
            
            .login-logo {
                max-width: 150px;
                max-height: 80px;
            }
        }
        
        /* Main App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        /* Mobile Responsive */
        @media (max-width: 767px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                min-height: auto;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .sidebar-header {
                padding: 0.75rem;
                border-bottom: none;
                border-right: 1px solid var(--gray-700);
                flex: 1;
            }
            
            .sidebar-logo {
                max-width: 120px;
                max-height: 50px;
                margin-bottom: 0;
            }
            
            .nav {
                display: flex;
                overflow-x: auto;
                padding: 0;
                flex: 1;
            }
            
            .nav-item {
                padding: 0.75rem 1rem;
                white-space: nowrap;
                font-size: 0.75rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .btn {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                min-height: 44px;
                min-width: 44px;
            }
            
            .btn-action {
                padding: 0.5rem 1rem;
                min-height: 40px;
            }
            
            .modal-content {
                width: 95vw;
                max-height: 90vh;
                padding: 1rem;
            }
            
            table {
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 0.5rem 0.25rem;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .print-info-grid {
                grid-template-columns: 1fr;
            }
            
            .print-signatures {
                grid-template-columns: 1fr;
            }
        }
        
        /* Tablet Responsive */
        @media (min-width: 768px) and (max-width: 1023px) {
            .sidebar {
                width: 200px;
            }
            
            .sidebar-logo {
                max-width: 160px;
                max-height: 60px;
            }
            
            .nav-item {
                padding: 0.6rem 1.2rem;
                font-size: 0.85rem;
            }
            
            .main-content {
                padding: 1.5rem;
            }
            
            .card {
                padding: 1.2rem;
            }
            
            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
                min-height: 40px;
            }
            
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        /* Desktop */
        @media (min-width: 1024px) {
            .app-container {
                flex-direction: row;
            }
            
            .sidebar {
                width: 256px;
                min-height: 100vh;
            }
            
            .sidebar-header {
                border-right: none;
                border-bottom: 1px solid var(--gray-700);
            }
            
            .nav {
                flex-direction: column;
                overflow-x: visible;
            }
            
            .nav-item {
                font-size: 1rem;
            }
        }
        
        /* Print Styles */
        @media print {
            * {
                margin: 0;
                padding: 0;
            }
            
            body {
                margin: 0;
                padding: 0;
            }
            
            body * {
                visibility: hidden;
            }
            
            #printArea, #printArea * {
                visibility: visible;
            }
            
            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                page-break-after: avoid;
            }
        }

        /* Optimized Print Document */
        .print-document {
            width: 210mm;
            padding: 7mm;
            background: white;
            box-sizing: border-box;
            font-size: 8.5pt;
            page-break-after: avoid;
            page-break-inside: avoid;
        }

        .print-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 2px solid #000;
        }

        .print-header-left {
            flex: 1;
        }

        .print-logo {
            max-width: 150px;
            max-height: 70px;
            object-fit: contain;
            margin-bottom: 4px;
        }

        .print-header-right {
            text-align: right;
        }

        .print-company-name {
            font-size: 16pt;
            font-weight: bold;
            color: #DC2626;
            margin: 0;
        }

        .print-subtitle {
            font-size: 8pt;
            color: #666;
            margin: 2px 0;
        }

        .print-transfer-id {
            font-size: 10pt;
            font-weight: bold;
            padding: 4px 8px;
            border: 2px solid #000;
            display: inline-block;
            margin-bottom: 4px;
        }

        .print-barcode {
            margin-top: 4px;
        }

        .print-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 6px;
        }

        .print-section {
            background: #f5f5f5;
            padding: 5px;
            border-left: 3px solid #DC2626;
        }

        .print-section-title {
            font-size: 8pt;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 4px;
            color: #DC2626;
        }

        .print-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 8pt;
            margin-bottom: 2px;
        }

        .print-info-label {
            font-weight: bold;
            color: #555;
        }

        .print-items-section {
            margin: 6px 0;
            page-break-inside: avoid;
        }

        .print-items-title {
            font-size: 9pt;
            font-weight: bold;
            text-transform: uppercase;
            background: #f5f5f5;
            padding: 4px 6px;
            border-left: 3px solid #DC2626;
            margin-bottom: 4px;
        }

        .print-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 6.5pt;
        }

        .print-items-table th {
            background: #333;
            color: white;
            padding: 2px 3px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #333;
        }

        .print-items-table td {
            padding: 1.5px 3px;
            border: 1px solid #ddd;
        }

        .print-items-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .print-signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
            page-break-inside: avoid;
        }

        .print-signature-box {
            border: 1px solid #333;
            padding: 6px;
            min-height: 60px;
        }

        .print-signature-title {
            font-size: 8pt;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .print-signature-line {
            border-bottom: 1px solid #333;
            margin: 25px 0 4px 0;
        }

        .print-signature-info {
            font-size: 7pt;
            color: #666;
        }
        
        /* Barcode Label */
        .barcode-label {
            width: 100mm;
            height: 50mm;
            border: 2px dashed #333;
            padding: 10px;
            margin: 10px;
            display: inline-block;
            page-break-inside: avoid;
            text-align: center;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            cursor: pointer;
            border-radius: 0.375rem;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--gray-100);
        }
        
        .pagination button.active {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Transfer Items */
        .transfer-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p style="color: white; margin-top: 1rem;">Loading...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden login-container">
        <div class="login-box">
            <div class="text-center mb-6">
                <img id="loginLogo" class="login-logo mx-auto hidden" alt="Company Logo">
                <h1 class="text-3xl font-bold text-gray-800">Fairfield</h1>
                <p class="text-gray-600 mt-2">Stock Control System</p>
            </div>
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email" style="margin-bottom: 1rem;">
                <input type="password" id="loginPassword" placeholder="Password" style="margin-bottom: 1.5rem;">
                <button onclick="login()" class="btn btn-primary w-full py-3 text-lg">Login</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img id="sidebarLogo" class="sidebar-logo hidden" alt="Company Logo">
                <h2 class="text-xl font-bold">Fairfield Stock Control System</h2>
                <p class="text-sm text-gray-400" id="userEmail"></p>
            </div>
            <nav class="nav">
                <div class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
                <div class="nav-item" onclick="showSection('products')">üì¶ Products</div>
                <div class="nav-item" onclick="showSection('locations')">üìç Locations</div>
                <div class="nav-item" onclick="showSection('newTransfer')">‚ûï New Transfer</div>
                <div class="nav-item" onclick="showSection('dispatch')">üì§ Dispatch</div>
                <div class="nav-item" onclick="showSection('receive')">üì• Receive</div>
                <div class="nav-item" onclick="showSection('returns')">‚Ü©Ô∏è Returns</div>
                <div class="nav-item" onclick="showSection('allTransfers')">üìã All Transfers</div>
                <div class="nav-item" onclick="showSection('reports')">üìà Reports & Analytics</div>
                <div class="nav-item" id="usersNavItem" onclick="showSection('users')">üë• User Management</div>
                <div class="nav-item" id="settingsNavItem" onclick="showSection('settings')">‚öôÔ∏è Settings</div>
                <div class="nav-item" onclick="logout()">üö™ Logout</div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section">
                <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                <div class="grid-4 gap-6 mb-8">
                    <div class="stat-card blue" onclick="showSection('products')">
                        <div class="text-sm" style="opacity: 0.9;">Total Products</div>
                        <div class="text-3xl font-bold mt-2" id="statProducts">0</div>
                    </div>
                    <div class="stat-card green" onclick="showSection('locations')">
                        <div class="text-sm" style="opacity: 0.9;">Locations</div>
                        <div class="text-3xl font-bold mt-2" id="statLocations">0</div>
                    </div>
                    <div class="stat-card orange" onclick="showSection('dispatch')">
                        <div class="text-sm" style="opacity: 0.9;">Pending Transfers</div>
                        <div class="text-3xl font-bold mt-2" id="statPending">0</div>
                    </div>
                    <div class="stat-card red" onclick="showSection('receive')">
                        <div class="text-sm" style="opacity: 0.9;">In Transit</div>
                        <div class="text-3xl font-bold mt-2" id="statTransit">0</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Recent Transfers</h2>
                    <div id="recentTransfersList"></div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="productsSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Products</h1>
                    <div class="flex gap-2">
                        <button onclick="downloadProductReport()" class="btn btn-success">üì• Download Report</button>
                        <button onclick="showAddProductModal()" class="btn btn-primary">‚ûï Add Product</button>
                    </div>
                </div>
                <div class="card">
                    <div class="mb-4">
                        <input type="text" id="productSearch" placeholder="Search products by name or code..." 
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 1rem;">
                    </div>
                    <div id="productsList"></div>
                    <div id="productsPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Locations Section -->
            <div id="locationsSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Locations</h1>
                    <button onclick="showAddLocationModal()" class="btn btn-primary">‚ûï Add Location</button>
                </div>
                <div class="card">
                    <div id="locationsList"></div>
                </div>
            </div>

            <!-- New Transfer Section -->
            <div id="newTransferSection" class="section hidden">
                <h1 class="text-3xl font-bold mb-6">Create New Transfer</h1>
                <div class="card">
                    <form id="transferForm">
                        <div class="grid-2 gap-4 mb-6">
                            <div>
                                <label>From Location</label>
                                <select id="fromLocation" required>
                                    <option value="">Select location...</option>
                                </select>
                            </div>
                            <div>
                                <label>To Location</label>
                                <select id="toLocation" required>
                                    <option value="">Select location...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label>Driver Name</label>
                            <select id="driverName" required>
                                <option value="">Select Driver...</option>
                            </select>
                        </div>
                        
                        <div class="mb-6">
                            <label>Vehicle Registration Number</label>
                            <input type="text" id="vehicleReg" required>
                        </div>
                        
                        <h3 class="text-lg font-bold mb-4">Products</h3>
                        
                        <!-- Product Search Helper -->
                        <div class="mb-4">
                            <label>Search Products (to find in dropdown faster)</label>
                            <input type="text" id="transferProductSearchFilter" placeholder="Type to filter products in dropdowns below..." 
                                   oninput="filterTransferProductDropdowns()" style="width: 100%;">
                        </div>
                        
                        <div id="transferItems"></div>
                        <button type="button" onclick="addTransferItem()" class="btn btn-secondary mb-6">+ Add Product</button>
                        
                        <button type="submit" class="btn btn-primary">Create Transfer</button>
                    </form>
                </div>
            </div>

            <!-- Dispatch Section -->
            <div id="dispatchSection" class="section hidden">
                <h1 class="text-3xl font-bold mb-6">Dispatch Transfers</h1>
                <div class="card">
                    <p class="text-gray-600 mb-4">View and dispatch pending transfers</p>
                    <div id="dispatchList"></div>
                    <div id="dispatchPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Receive Section -->
            <div id="receiveSection" class="section hidden">
                <h1 class="text-3xl font-bold mb-6">Receive Transfers</h1>
                <div class="card">
                    <p class="text-gray-600 mb-4">View and confirm receipt of in-transit transfers</p>
                    <div id="receiveList"></div>
                    <div id="receivePagination" class="pagination"></div>
                </div>
            </div>

            <!-- Returns Section -->
            <div id="returnsSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Returns Management</h2>
                        <p class="text-gray-600">Log and track product returns with reasons</p>
                    </div>
                    <button onclick="showLogReturnModal()" class="btn btn-primary">+ Log Return</button>
                </div>
                
                <!-- Returns Statistics -->
                <div class="grid-3 gap-6 mb-6">
                    <div class="stat-card red">
                        <div class="text-sm" style="opacity: 0.9;">Total Returns</div>
                        <div class="text-3xl font-bold mt-2" id="statTotalReturns">0</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="text-sm" style="opacity: 0.9;">This Month</div>
                        <div class="text-3xl font-bold mt-2" id="statMonthReturns">0</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="text-sm" style="opacity: 0.9;">Total Items</div>
                        <div class="text-3xl font-bold mt-2" id="statReturnItems">0</div>
                    </div>
                </div>

                <!-- Returns List -->
                <div class="card">
                    <h3 class="text-xl font-bold mb-4">Returns History</h3>
                    <div class="mb-4 flex gap-2">
                        <input type="text" id="searchReturns" placeholder="Search return ID, transfer ID, or product..." 
                               oninput="renderReturns()" style="flex: 1;">
                        <input type="date" id="filterReturnDate" onchange="renderReturns()" style="flex: 0 0 auto;">
                        <select id="filterReturnMonth" onchange="renderReturns()">
                            <option value="">All Time</option>
                        </select>
                    </div>
                    <div id="returnsList"></div>
                    <div id="returnsPagination" class="pagination"></div>
                </div>
            </div>

            <!-- All Transfers Section -->
            <div id="allTransfersSection" class="section hidden">
                <h1 class="text-3xl font-bold mb-6">All Transfers</h1>
                <div class="card">
                    <div class="mb-4 flex gap-2">
                        <input type="text" id="searchTransfers" placeholder="Search transfer ID..." 
                               oninput="renderAllTransfers()" style="flex: 1;">
                        <select id="filterStatus" onchange="renderAllTransfers()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="in_transit">In Transit</option>
                            <option value="received">Received</option>
                        </select>
                    </div>
                    <div id="allTransfersList"></div>
                    <div id="allTransfersPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="section hidden">
                <h1 class="text-3xl font-bold mb-6">Reports & Analytics</h1>
                
                <!-- Report Type Selection -->
                <div class="card mb-6">
                    <h2 class="text-xl font-bold mb-4">Select Report Type</h2>
                    <div class="grid-3 gap-4">
                        <button onclick="showReportSection('custom')" class="btn btn-primary">Custom Date Range</button>
                        <button onclick="showReportSection('monthly')" class="btn btn-primary">Monthly Branch Report</button>
                        <button onclick="showReportSection('detailed')" class="btn btn-primary">Detailed Analytics</button>
                    </div>
                </div>
                
                <!-- Custom Date Range Selection -->
                <div id="customReportSection" class="card mb-6 hidden">
                    <h2 class="text-xl font-bold mb-4">Generate Custom Report</h2>
                    <div class="grid-3 gap-4 mb-4">
                        <div>
                            <label>From Date</label>
                            <input type="date" id="reportFromDate">
                        </div>
                        <div>
                            <label>To Date</label>
                            <input type="date" id="reportToDate">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="generateCustomReport()" class="btn btn-primary w-full">Generate Report</button>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Branch Stock Summary -->
                <div id="monthlyReportSection" class="card mb-6 hidden">
                    <h2 class="text-xl font-bold mb-4">Monthly Stock by Branch</h2>
                    <div class="grid-2 gap-4 mb-4">
                        <div>
                            <label>Select Month</label>
                            <input type="month" id="monthlyReportMonth">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="generateMonthlyBranchReport()" class="btn btn-primary w-full">View Monthly Summary</button>
                        </div>
                    </div>
                    <div id="monthlyBranchReport"></div>
                </div>
                
                <!-- Detailed Analytics -->
                <div id="detailedReportSection" class="card mb-6 hidden">
                    <h2 class="text-xl font-bold mb-4">Detailed Analytics</h2>
                    <div class="grid-2 gap-4 mb-4">
                        <div>
                            <label>Select Month</label>
                            <input type="month" id="detailedReportMonth">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="generateDetailedReport()" class="btn btn-primary w-full">Generate Detailed Report</button>
                        </div>
                    </div>
                    <div id="detailedReportContent"></div>
                </div>
                
                <!-- Returns by Branch Summary -->
                <div class="card mb-6">
                    <h2 class="text-xl font-bold mb-4">Returns Logged by Branch</h2>
                    <p class="text-gray-600 mb-4">Summary of product returns logged per branch location</p>
                    <div id="returnsByBranchContent"></div>
                </div>
                
                <!-- Transfer History -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Transfer History</h2>
                    <div id="transferHistory"></div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">User Management</h2>
                        <p class="text-gray-600">Manage system users and permissions</p>
                    </div>
                    <button onclick="showAddUserModal()" class="btn btn-primary" id="addUserBtn">+ Add User</button>
                </div>

                <div class="card mb-6">
                    <h3 class="text-lg font-semibold mb-3">Permission Levels</h3>
                    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="border rounded-lg p-4" style="border-color: var(--gray-200);">
                            <div class="role-badge role-admin mb-2">Admin</div>
                            <p class="text-sm text-gray-600">Full system access</p>
                            <ul class="text-xs text-gray-500 mt-2" style="list-style: none; padding: 0;">
                                <li style="margin: 0.25rem 0;">‚úì View all data</li>
                                <li style="margin: 0.25rem 0;">‚úì Create/Edit/Delete</li>
                                <li style="margin: 0.25rem 0;">‚úì Manage users</li>
                                <li style="margin: 0.25rem 0;">‚úì Generate reports</li>
                                <li style="margin: 0.25rem 0;">‚úì Access settings</li>
                            </ul>
                        </div>
                        <div class="border rounded-lg p-4" style="border-color: var(--gray-200);">
                            <div class="role-badge role-dispatch mb-2">Dispatch</div>
                            <p class="text-sm text-gray-600">Dispatch transfers only</p>
                            <ul class="text-xs text-gray-500 mt-2" style="list-style: none; padding: 0;">
                                <li style="margin: 0.25rem 0;">‚úì View transfers</li>
                                <li style="margin: 0.25rem 0;">‚úì Dispatch transfers</li>
                                <li style="margin: 0.25rem 0;">‚úì View products</li>
                                <li style="margin: 0.25rem 0;">‚úó Create transfers</li>
                                <li style="margin: 0.25rem 0;">‚úó Receive transfers</li>
                            </ul>
                        </div>
                        <div class="border rounded-lg p-4" style="border-color: var(--gray-200);">
                            <div class="role-badge role-receiver mb-2">Receiver</div>
                            <p class="text-sm text-gray-600">Receive incoming stock</p>
                            <ul class="text-xs text-gray-500 mt-2" style="list-style: none; padding: 0;">
                                <li style="margin: 0.25rem 0;">‚úì View transfers</li>
                                <li style="margin: 0.25rem 0;">‚úì Receive transfers</li>
                                <li style="margin: 0.25rem 0;">‚úì View products</li>
                                <li style="margin: 0.25rem 0;">‚úó Create transfers</li>
                                <li style="margin: 0.25rem 0;">‚úó Dispatch transfers</li>
                            </ul>
                        </div>
                        <div class="border rounded-lg p-4" style="border-color: var(--gray-200);">
                            <div class="role-badge role-view-only mb-2">View Only</div>
                            <p class="text-sm text-gray-600">Read-only access</p>
                            <ul class="text-xs text-gray-500 mt-2" style="list-style: none; padding: 0;">
                                <li style="margin: 0.25rem 0;">‚úì View transfers</li>
                                <li style="margin: 0.25rem 0;">‚úì View products</li>
                                <li style="margin: 0.25rem 0;">‚úó Create/Edit</li>
                                <li style="margin: 0.25rem 0;">‚úó Delete</li>
                                <li style="margin: 0.25rem 0;">‚úó Dispatch/Receive</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Permissions</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="6" class="text-center text-gray-500">No users found</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="section hidden">
                <h1 class="text-3xl font-bold mb-6">Settings</h1>
                
                <!-- Logo Upload -->
                <div class="card mb-6">
                    <h2 class="text-xl font-bold mb-4">Company Logo</h2>
                    <p class="text-gray-600 mb-4">Upload your company logo to display on login page and documents</p>
                    <div class="logo-upload-area" onclick="document.getElementById('logoUpload').click()">
                        <div id="logoPreview">
                            <div class="text-center text-gray-500">
                                <div class="text-4xl mb-2">üì∑</div>
                                <div>Click to upload logo</div>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="logoUpload" class="hidden" accept="image/*" onchange="handleLogoUpload(event)">
                </div>
                
                <!-- User Management -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">User Management</h2>
                        <button onclick="showAddUserModal()" class="btn btn-primary">‚ûï Add User</button>
                    </div>
                    <div id="usersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal hidden">
        <div class="modal-content p-6" style="width: 24rem;">
            <h2 class="text-2xl font-bold mb-4">Add New Product</h2>
            <form id="addProductForm">
                <div class="mb-4">
                    <label>Product Code</label>
                    <input type="text" id="productCode" required>
                </div>
                <div class="mb-4">
                    <label>Product Name</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="mb-4">
                    <label>Category</label>
                    <input type="text" id="productCategory" required list="categoryList">
                    <datalist id="categoryList"></datalist>
                </div>
                <div class="mb-4">
                    <label>Unit</label>
                    <select id="productUnit" required>
                        <option value="pieces">Pieces</option>
                        <option value="boxes">Boxes</option>
                        <option value="kg">Kilograms</option>
                        <option value="liters">Liters</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary flex-1">Add Product</button>
                    <button type="button" onclick="closeModal('addProductModal')" class="btn btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal hidden">
        <div class="modal-content p-6" style="width: 24rem;">
            <h2 class="text-2xl font-bold mb-4">Edit Product</h2>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="mb-4">
                    <label>Product Code</label>
                    <input type="text" id="editProductCode" required>
                </div>
                <div class="mb-4">
                    <label>Product Name</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="mb-4">
                    <label>Category</label>
                    <input type="text" id="editProductCategory" required list="categoryList">
                </div>
                <div class="mb-4">
                    <label>Unit</label>
                    <select id="editProductUnit" required>
                        <option value="kg">Kilograms (kg)</option>
                        <option value="pcs">Pieces (pcs)</option>
                        <option value="box">Box</option>
                        <option value="ltr">Liters (ltr)</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary flex-1">Save Changes</button>
                    <button type="button" onclick="closeModal('editProductModal')" class="btn btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Location Modal -->
    <div id="addLocationModal" class="modal hidden">
        <div class="modal-content p-6" style="width: 24rem;">
            <h2 class="text-2xl font-bold mb-4">Add New Location</h2>
            <form id="addLocationForm">
                <div class="mb-4">
                    <label>Location Name</label>
                    <input type="text" id="locationName" required>
                </div>
                <div class="mb-4">
                    <label>Address</label>
                    <textarea id="locationAddress" rows="3"></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary flex-1">Add Location</button>
                    <button type="button" onclick="closeModal('addLocationModal')" class="btn btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Location Modal -->
    <div id="editLocationModal" class="modal hidden">
        <div class="modal-content p-6" style="width: 24rem;">
            <h2 class="text-2xl font-bold mb-4">Edit Location</h2>
            <form id="editLocationForm">
                <input type="hidden" id="editLocationId">
                <div class="mb-4">
                    <label>Location Name</label>
                    <input type="text" id="editLocationName" required>
                </div>
                <div class="mb-4">
                    <label>Address</label>
                    <textarea id="editLocationAddress" rows="3"></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary flex-1">Save Changes</button>
                    <button type="button" onclick="closeModal('editLocationModal')" class="btn btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal hidden">
        <div class="modal-content p-6" style="width: 24rem;">
            <h2 class="text-2xl font-bold mb-4">Add New User</h2>
            <form id="addUserForm">
                <div class="mb-4">
                    <label>Name</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="mb-4">
                    <label>Email</label>
                    <input type="email" id="newUserEmail" required>
                </div>
                <div class="mb-4">
                    <label>Password</label>
                    <input type="password" id="userPassword" required>
                </div>
                <div class="mb-4">
                    <label>Role</label>
                    <select id="userRole" required onchange="updatePermissionOptions()">
                        <option value="admin">Admin</option>
                        <option value="dispatch">Dispatch</option>
                        <option value="receiver">Receiver</option>
                        <option value="view_only">View Only</option>
                    </select>
                </div>
                <div id="userPermissions" class="mb-4">
                    <label>Permissions</label>
                    <div id="permissionsList"></div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary flex-1">Add User</button>
                    <button type="button" onclick="closeModal('addUserModal')" class="btn btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Permissions Modal -->
    <div id="editUserPermissionsModal" class="modal hidden">
        <div class="modal-content p-6" style="max-width: 600px;">
            <h3 class="text-xl font-bold mb-4">Edit User Permissions</h3>
            <form id="editUserPermissionsForm" class="space-y-4" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" id="editUserId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User</label>
                    <p id="editUserName" class="font-semibold text-gray-800"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="editUserRole" onchange="updateEditRolePermissions()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 0.375rem;">
                        <option value="admin">Admin - Full Access</option>
                        <option value="dispatch">Dispatch - Dispatch Transfers Only</option>
                        <option value="receiver">Receiver - Receive Transfers Only</option>
                        <option value="view_only">View Only - Read Access</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Custom Permissions</label>
                    <div style="border: 1px solid var(--gray-200); border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_view_transfers" style="margin-right: 0.5rem;">
                            <span class="text-sm">View Transfers</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_create_transfers" style="margin-right: 0.5rem;">
                            <span class="text-sm">Create Transfers</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_dispatch_transfers" style="margin-right: 0.5rem;">
                            <span class="text-sm">Dispatch Transfers</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_receive_transfers" style="margin-right: 0.5rem;">
                            <span class="text-sm">Receive Transfers</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_view_products" style="margin-right: 0.5rem;">
                            <span class="text-sm">View Products</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_add_products" style="margin-right: 0.5rem;">
                            <span class="text-sm">Add Products</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_edit_products" style="margin-right: 0.5rem;">
                            <span class="text-sm">Edit Products</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_delete_products" style="margin-right: 0.5rem;">
                            <span class="text-sm">Delete Products</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_manage_users" style="margin-right: 0.5rem;">
                            <span class="text-sm">Manage Users</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_generate_reports" style="margin-right: 0.5rem;">
                            <span class="text-sm">Generate Reports</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="edit_perm_access_settings" style="margin-right: 0.5rem;">
                            <span class="text-sm">Access Settings</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary flex-1">Save Changes</button>
                    <button type="button" onclick="closeModal('editUserPermissionsModal')" class="btn btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transfer Details Modal -->
    <div id="transferDetailsModal" class="modal hidden">
        <div class="modal-content p-6" style="max-width: 1000px;">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl font-bold">Transfer Details</h2>
                <button onclick="closeModal('transferDetailsModal')" class="text-gray-500 text-2xl" style="border: none; background: none; cursor: pointer; line-height: 1;">&times;</button>
            </div>
            <div id="transferDetailsContent"></div>
        </div>
    </div>

    <!-- Receive Confirmation Modal -->
    <div id="receiveConfirmationModal" class="modal hidden">
        <div class="modal-content p-6" style="max-width: 900px;">
            <h2 class="text-2xl font-bold mb-4">Confirm Receipt</h2>
            <p class="text-gray-600 mb-4">Please confirm the quantities received and note any damaged or short items.</p>
            <div id="receiveItemsList"></div>
            <div class="flex gap-3 mt-6">
                <button onclick="confirmReceiveTransfer()" class="btn btn-success flex-1">Confirm Receipt</button>
                <button onclick="closeModal('receiveConfirmationModal')" class="btn btn-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Log Return Modal -->
    <div id="logReturnModal" class="modal hidden">
        <div class="modal-content p-6" style="max-width: 600px;">
            <h2 class="text-2xl font-bold mb-4">Log Return</h2>
            <form id="logReturnForm">
                <div class="mb-4">
                    <label>Return Type</label>
                    <select id="returnType" required onchange="handleReturnTypeChange()">
                        <option value="">Select Type...</option>
                        <option value="transfer">From Transfer</option>
                        <option value="standalone">Standalone Return</option>
                    </select>
                </div>
                
                <div id="transferSelectDiv" class="mb-4 hidden">
                    <label>Select Transfer</label>
                    <select id="returnTransferId" onchange="handleReturnTransferChange()">
                        <option value="">Select Transfer...</option>
                    </select>
                </div>
                
                <div id="returnProductsDiv" class="mb-4">
                    <label>Product</label>
                    <select id="returnProduct" required>
                        <option value="">Select Product...</option>
                    </select>
                </div>
                
                <div class="grid-2 gap-4 mb-4">
                    <div>
                        <label>Quantity Returned</label>
                        <input type="number" id="returnQuantity" required min="1">
                    </div>
                    <div>
                        <label>Unit</label>
                        <input type="text" id="returnUnit" readonly style="background: #F3F4F6;">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label>Return Reason</label>
                    <select id="returnReason" required>
                        <option value="">Select Reason...</option>
                        <option value="damaged">Damaged</option>
                        <option value="expired">Expired</option>
                        <option value="quality_issue">Quality Issue</option>
                        <option value="wrong_product">Wrong Product</option>
                        <option value="customer_return">Customer Return</option>
                        <option value="overstocked">Overstocked</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label>Additional Notes (Optional)</label>
                    <textarea id="returnNotes" rows="3" placeholder="Enter any additional details..."></textarea>
                </div>
                
                <div class="mb-4">
                    <label>Return Location</label>
                    <select id="returnLocation" required>
                        <option value="">Select Location...</option>
                    </select>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary flex-1">Log Return</button>
                    <button type="button" onclick="closeModal('logReturnModal')" class="btn btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Area (Hidden) -->
    <div id="printArea" style="display: none;"></div>

    <script>
        // Global State
        const DB = {
            products: [],
            locations: [],
            transfers: [],
            users: [],
            returns: [],
            drivers: [],
            currentUser: null,
            companyLogo: null
        };

        let currentPage = 1;
        const itemsPerPage = 15;
        let transferItemCount = 0;
        let currentPageType = 'products'; // Track which page we're on for pagination

        // Initialize App
        window.initializeApp = async function() {
            const { onAuthStateChanged } = window.firebaseModules;
            
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    DB.currentUser = user;
                    await loadUserData();
                    await loadAllData();
                    loadCompanyLogo();
                    showMainApp();
                    
                    // Get user name from database
                    const dbUser = DB.users.find(u => u.email === user.email);
                    const displayName = dbUser && dbUser.name ? dbUser.name : user.email.split('@')[0];
                    document.getElementById('userEmail').textContent = displayName;
                    updateDashboard();
                } else {
                    showLoginScreen();
                }
            });
        }

        // Authentication
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const { signInWithEmailAndPassword } = window.firebaseModules;
                await signInWithEmailAndPassword(window.auth, email, password);
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        async function logout() {
            const { signOut } = window.firebaseModules;
            await signOut(window.auth);
        }

        // Load Data
        async function loadAllData() {
            await Promise.all([
                loadProducts(),
                loadLocations(),
                loadTransfers(),
                loadUsers(),
                loadReturns(),
                loadDrivers()
            ]);
        }

        async function loadUserData() {
            const { getDocs, collection, query, where } = window.firebaseModules;
            
            try {
                const q = query(collection(window.db, 'users'), where('email', '==', DB.currentUser.email));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const userData = snapshot.docs[0].data();
                    DB.currentUser.id = snapshot.docs[0].id;
                    DB.currentUser.role = userData.role || 'admin';
                    DB.currentUser.name = userData.name || DB.currentUser.email.split('@')[0];
                    DB.currentUser.permissions = userData.permissions || getRolePermissions(userData.role || 'admin');
                } else {
                    // Default to admin if user not found
                    DB.currentUser.role = 'admin';
                    DB.currentUser.permissions = getRolePermissions('admin');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                DB.currentUser.role = 'admin';
                DB.currentUser.permissions = getRolePermissions('admin');
            }
        }

        async function loadProducts() {
            const { getDocs, collection } = window.firebaseModules;
            const snapshot = await getDocs(collection(window.db, 'products'));
            DB.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderProducts();
        }

        async function loadLocations() {
            const { getDocs, collection } = window.firebaseModules;
            const snapshot = await getDocs(collection(window.db, 'locations'));
            DB.locations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderLocations();
            populateLocationSelects();
        }

        async function loadTransfers() {
            const { getDocs, collection, orderBy, query } = window.firebaseModules;
            const q = query(collection(window.db, 'transfers'), orderBy('created_at', 'desc'));
            const snapshot = await getDocs(q);
            DB.transfers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAllTransfers();
            renderDispatchList();
            renderReceiveList();
            renderRecentTransfers();
        }

        async function loadUsers() {
            const { getDocs, collection } = window.firebaseModules;
            const snapshot = await getDocs(collection(window.db, 'users'));
            DB.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderUsers();
        }

        async function loadReturns() {
            const { getDocs, collection, orderBy, query } = window.firebaseModules;
            const q = query(collection(window.db, 'returns'), orderBy('created_at', 'desc'));
            const snapshot = await getDocs(q);
            DB.returns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.getElementById('returnsSection') && !document.getElementById('returnsSection').classList.contains('hidden')) {
                renderReturns();
                updateReturnsStats();
            }
        }
        
        async function loadDrivers() {
            const { getDocs, collection } = window.firebaseModules;
            try {
                const snapshot = await getDocs(collection(window.db, 'drivers'));
                DB.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateDriverSelect();
            } catch (e) {
                // Drivers collection may not exist yet
                DB.drivers = [];
            }
        }

        // Company Logo Management - Real-time Sync with Firestore
        function loadCompanyLogo() {
            const { onSnapshot, doc, collection } = window.firebaseModules;
            
            try {
                const settingsRef = doc(collection(window.db, 'settings'), 'company');
                onSnapshot(settingsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const settings = snapshot.data();
                        if (settings && settings.companyLogo) {
                            DB.companyLogo = settings.companyLogo;
                            updateLogoDisplay(settings.companyLogo);
                        }
                    }
                }, (error) => {
                    console.error('Error syncing logo from Firestore:', error.message);
                });
            } catch (error) {
                console.error('Error setting up logo sync:', error.message);
            }
        }

        function updateLogoDisplay(logo) {
            const loginLogo = document.getElementById('loginLogo');
            const sidebarLogo = document.getElementById('sidebarLogo');
            const logoPreview = document.getElementById('logoPreview');
            
            if (loginLogo) {
                loginLogo.src = logo;
                loginLogo.classList.remove('hidden');
            }
            if (sidebarLogo) {
                sidebarLogo.src = logo;
                sidebarLogo.classList.remove('hidden');
            }
            if (logoPreview) {
                logoPreview.innerHTML = `<img src="${logo}" alt="Company Logo">`;
            }
        }

        async function handleLogoUpload(event) {
            const file = event.target.files[0];
            console.log('Logo upload started, file:', file?.name);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        console.log('File read started');
                        const logo = e.target.result;
                        console.log('Logo data URL length:', logo.length);
                        
                        const { setDoc, doc, collection } = window.firebaseModules;
                        
                        // Save to Firestore settings
                        const settingsRef = doc(collection(window.db, 'settings'), 'company');
                        console.log('Saving to Firestore...');
                        await setDoc(settingsRef, { companyLogo: logo }, { merge: true });
                        console.log('Logo saved to Firestore');
                        
                        DB.companyLogo = logo;
                        alert('Logo uploaded successfully and synced across all devices!');
                    } catch (error) {
                        console.error('Error uploading logo:', error);
                        alert('Error uploading logo: ' + error.message);
                    }
                };
                reader.readAsDataURL(file);
            } else {
                console.log('No file selected');
            }
        }

        // Render Functions
        function renderProducts() {
            // Clear any search term and render all products from page 1
            const searchInput = document.getElementById('productSearch');
            if (searchInput) {
                searchInput.value = '';
                // Remove any existing listeners and add fresh one
                searchInput.removeEventListener('input', handleSearchInput);
                searchInput.addEventListener('input', handleSearchInput);
            }
            filterProducts(true);
            updateCategoryFilters();
        }
        
        function handleSearchInput(e) {
            filterProducts(true);
        }

        function filterProducts(resetPage = false) {
            const searchInput = document.getElementById('productSearch');
            const searchTerm = searchInput?.value.toLowerCase() || '';

            let filtered = DB.products;

            if (searchTerm) {
                filtered = filtered.filter(p => 
                    (p.name && p.name.toLowerCase().includes(searchTerm)) ||
                    (p.code && p.code.toLowerCase().includes(searchTerm))
                );
            }

            if (resetPage) {
                currentPage = 1;
            }

            // Clamp currentPage to valid range for the current dataset
            const totalPages = Math.max(1, Math.ceil(filtered.length / itemsPerPage));
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }

            currentPageType = 'products';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedProducts = filtered.slice(start, end);

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.length > 0 ? paginatedProducts.map(p => `
                            <tr>
                                <td>${p.code}</td>
                                <td>${p.name}</td>
                                <td>${p.category || '-'}</td>
                                <td>${p.unit}</td>
                                <td>
                                    <button onclick="editProduct('${p.id}')" class="btn btn-secondary text-sm">Edit</button>
                                    <button onclick="deleteProduct('${p.id}')" class="btn-action btn-action-delete text-sm ml-2">Delete</button>
                                </td>
                            </tr>
                        `).join('') : '<tr><td colspan="5" class="text-center text-gray-500">No products found</td></tr>'}
                    </tbody>
                </table>
            `;
            
            document.getElementById('productsList').innerHTML = html;
            renderPagination('productsPagination', filtered.length, 'products', filtered);
        }

        function updateCategoryFilters() {
            const categories = [...new Set(DB.products.map(p => p.category).filter(c => c))];
            
            const categoryList = document.getElementById('categoryList');
            if (categoryList) {
                categoryList.innerHTML = categories.map(c => `<option value="${c}">`).join('');
            }
        }

        function renderLocations() {
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Location Name</th>
                            <th>Address</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${DB.locations.map(l => `
                            <tr>
                                <td>${l.name}</td>
                                <td>${l.address || '-'}</td>
                                <td>
                                    <button onclick="editLocation('${l.id}')" class="btn btn-secondary text-sm">Edit</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('locationsList').innerHTML = html;
        }

        function renderAllTransfers() {
            const filterStatus = document.getElementById('filterStatus').value;
            const searchTerm = document.getElementById('searchTransfers')?.value.toLowerCase() || '';
            
            let filtered = DB.transfers;
            
            if (filterStatus) {
                filtered = filtered.filter(t => t.status === filterStatus);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.transfer_id.toLowerCase().includes(searchTerm) ||
                    t.from_location.toLowerCase().includes(searchTerm) ||
                    t.to_location.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPageType = 'allTransfers';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginated = filtered.slice(start, end);
            
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Transfer ID</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Items</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginated.map(t => `
                            <tr>
                                <td><strong>${t.transfer_id}</strong></td>
                                <td>${t.from_location}</td>
                                <td>${t.to_location}</td>
                                <td>${t.items.length} items</td>
                                <td>${getStatusBadge(t.status)}</td>
                                <td>${formatDate(t.created_at)}</td>
                                <td>
                                    <button onclick="viewTransferDetails('${t.id}')" class="btn btn-primary text-sm">View</button>
                                    <button onclick="printSingleTransfer('${t.id}')" class="btn btn-secondary text-sm ml-1">Print</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('allTransfersList').innerHTML = html;
            renderPagination('allTransfersPagination', filtered.length, 'allTransfers', filtered);
        }

        function renderDispatchList() {
            const pending = DB.transfers.filter(t => t.status === 'pending');
            currentPageType = 'dispatch';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginated = pending.slice(start, end);
            
            const html = paginated.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Transfer ID</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Items</th>
                            <th>Driver</th>
                            <th>Vehicle Reg. Number</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginated.map(t => `
                            <tr>
                                <td><strong>${t.transfer_id}</strong></td>
                                <td>${t.from_location}</td>
                                <td>${t.to_location}</td>
                                <td>${t.items.length} items</td>
                                <td>${t.driver_name}</td>
                                <td>${t.vehicle}</td>
                                <td>${formatDate(t.created_at)}</td>
                                <td>
                                    <button onclick="viewTransferDetails('${t.id}')" class="btn btn-primary text-sm">View</button>
                                    <button onclick="dispatchTransfer('${t.id}')" class="btn btn-success text-sm ml-1">Dispatch</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-gray-500 text-center py-8">No pending transfers to dispatch</p>';
            
            document.getElementById('dispatchList').innerHTML = html;
            renderPagination('dispatchPagination', pending.length, 'dispatch', pending);
        }

        function renderReceiveList() {
            const inTransit = DB.transfers.filter(t => t.status === 'in_transit');
            currentPageType = 'receive';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginated = inTransit.slice(start, end);
            
            const html = paginated.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Transfer ID</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Items</th>
                            <th>Driver</th>
                            <th>Vehicle Reg. Number</th>
                            <th>Dispatched</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginated.map(t => `
                            <tr>
                                <td><strong>${t.transfer_id}</strong></td>
                                <td>${t.from_location}</td>
                                <td>${t.to_location}</td>
                                <td>${t.items.length} items</td>
                                <td>${t.driver_name}</td>
                                <td>${t.vehicle}</td>
                                <td>${formatDateTime(t.dispatched_at)}</td>
                                <td>
                                    <button onclick="viewTransferDetails('${t.id}')" class="btn btn-primary text-sm">View</button>
                                    <button onclick="receiveTransfer('${t.id}')" class="btn btn-success text-sm ml-1">Receive</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-gray-500 text-center py-8">No transfers in transit to receive</p>';
            
            document.getElementById('receiveList').innerHTML = html;
            renderPagination('receivePagination', inTransit.length, 'receive', inTransit);
        }

        function renderRecentTransfers() {
            const recent = DB.transfers.slice(0, 5);
            const html = recent.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Transfer ID</th>
                            <th>From ‚Üí To</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recent.map(t => `
                            <tr>
                                <td><strong>${t.transfer_id}</strong></td>
                                <td>${t.from_location} ‚Üí ${t.to_location}</td>
                                <td>${getStatusBadge(t.status)}</td>
                                <td>${formatDate(t.created_at)}</td>
                                <td>
                                    <button onclick="viewTransferDetails('${t.id}')" class="btn btn-primary text-sm">View</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-gray-500 text-center py-4">No transfers yet</p>';
            
            document.getElementById('recentTransfersList').innerHTML = html;
        }

        function renderUsers() {
            // Render to usersTableBody (new dedicated Users section)
            const tbody = document.getElementById('usersTableBody');
            if (tbody) {
                if (DB.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No users found</td></tr>';
                } else {
                    tbody.innerHTML = DB.users.map(u => {
                        const perms = u.permissions || {};
                        const permCount = Object.values(perms).filter(Boolean).length;
                        const displayName = u.name || u.email.split('@')[0];
                        
                        return `
                        <tr>
                            <td>${displayName}</td>
                            <td>${u.email}</td>
                            <td>${getRoleBadge(u.role)}</td>
                            <td class="text-sm text-gray-600">${permCount} permissions</td>
                            <td><span class="status-badge status-received">Active</span></td>
                            <td>
                                <button onclick="editUser('${u.id}')" class="btn-action btn-action-edit">‚úèÔ∏è Edit</button>
                                <button onclick="deleteUser('${u.id}')" class="btn-action btn-action-delete">üóëÔ∏è Delete</button>
                            </td>
                        </tr>
                    `}).join('');
                }
            }
            
            // Also render to usersList (Settings section) for backward compatibility
            const usersList = document.getElementById('usersList');
            if (usersList) {
                const html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${DB.users.map(u => {
                                const displayName = u.name || u.email.split('@')[0];
                                return `
                                <tr>
                                    <td>${displayName}</td>
                                    <td>${u.email}</td>
                                    <td>${getRoleBadge(u.role)}</td>
                                    <td>${formatDate(u.created_at)}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                `;
                usersList.innerHTML = html;
            }
        }

        function renderPagination(elementId, totalItems, pageType, dataArray = null) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (totalPages <= 1) {
                document.getElementById(elementId).innerHTML = '';
                return;
            }
            
            let html = '<button onclick="changePage(' + (currentPage - 1) + ', \'' + pageType + '\', ' + (dataArray ? 'true' : 'false') + ')" ' + 
                (currentPage === 1 ? 'disabled' : '') + '>Previous</button>';
            
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="changePage(${i}, '${pageType}', ${dataArray ? 'true' : 'false'})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            }
            
            html += '<button onclick="changePage(' + (currentPage + 1) + ', \'' + pageType + '\', ' + (dataArray ? 'true' : 'false') + ')" ' + 
                (currentPage === totalPages ? 'disabled' : '') + '>Next</button>';
            
            document.getElementById(elementId).innerHTML = html;
        }

        function changePage(page, pageType, hasFilteredData = false) {
            let totalItems = 0;
            
            // Determine total items based on page type
            if (pageType === 'products') {
                if (hasFilteredData) {
                    // Update current page before filtering
                    currentPage = page;
                    currentPageType = pageType;
                    filterProducts();
                    return;
                }
                totalItems = DB.products.length;
            } else if (pageType === 'allTransfers') {
                if (hasFilteredData) {
                    // Update current page before rendering
                    currentPage = page;
                    currentPageType = pageType;
                    renderAllTransfers();
                    return;
                }
                totalItems = DB.transfers.length;
            } else if (pageType === 'dispatch') {
                totalItems = DB.transfers.filter(t => t.status === 'pending').length;
            } else if (pageType === 'receive') {
                totalItems = DB.transfers.filter(t => t.status === 'in_transit').length;
            }
            
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            currentPageType = pageType;
            
            if (pageType === 'products') {
                filterProducts();
            } else if (pageType === 'allTransfers') {
                renderAllTransfers();
            } else if (pageType === 'dispatch') {
                renderDispatchList();
            } else if (pageType === 'receive') {
                renderReceiveList();
            }
        }

        // View Transfer Details
        function viewTransferDetails(id) {
            const transfer = DB.transfers.find(t => t.id === id);
            if (!transfer) return;
            
            const isPending = transfer.status === 'pending';
            
            const html = `
                <div class="space-y-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-600">Transfer ID</div>
                                <div class="text-lg font-bold">${transfer.transfer_id}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Status</div>
                                <div class="mt-1">${getStatusBadge(transfer.status)}</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-2 gap-6">
                        <div class="border-l-4 border-red-600" style="padding-left: 1rem;">
                            <div class="text-sm font-bold text-gray-700 mb-2">DISPATCHED FROM</div>
                            <div class="text-lg">${transfer.from_location}</div>
                            <div class="text-sm text-gray-600 mt-2">Created: ${formatDateTime(transfer.created_at)}</div>
                            <div class="text-sm text-gray-600">By: ${getUserNameFromEmail(transfer.created_by) || 'System'}</div>
                            ${transfer.dispatched_at ? `
                                <div class="text-sm text-gray-600 mt-2">Dispatched: ${formatDateTime(transfer.dispatched_at)}</div>
                                <div class="text-sm text-gray-600">By: ${getUserNameFromEmail(transfer.dispatched_by)}</div>
                            ` : ''}
                        </div>
                        <div class="border-l-4 border-green-600" style="padding-left: 1rem;">
                            <div class="text-sm font-bold text-gray-700 mb-2">DELIVERY TO</div>
                            <div class="text-lg">${transfer.to_location}</div>
                            <div class="text-sm text-gray-600 mt-2">Driver: ${transfer.driver_name}</div>
                            <div class="text-sm text-gray-600">Vehicle Reg. Number: ${transfer.vehicle}</div>
                            ${transfer.received_at ? `
                                <div class="text-sm text-gray-600 mt-2">Received: ${formatDateTime(transfer.received_at)}</div>
                                <div class="text-sm text-gray-600">By: ${getUserNameFromEmail(transfer.received_by)}</div>
                            ` : ''}
                        </div>
                    </div>

                    ${isPending ? `
                        <div class="doc-pending-box">
                            ‚ö†Ô∏è PENDING RECEIPT - This transfer is awaiting receipt confirmation
                        </div>
                    ` : ''}

                    <div>
                        <div class="text-lg font-bold mb-3">ITEMS</div>
                        <table class="w-full border">
                            <thead>
                                <tr class="bg-gray-800 text-white">
                                    <th class="p-2 text-left" style="width: 40px;">#</th>
                                    <th class="p-2 text-left">Code</th>
                                    <th class="p-2 text-left">Product</th>
                                    <th class="p-2 text-center">Dispatched</th>
                                    <th class="p-2 text-center">Type</th>
                                    <th class="p-2 text-center">Unit</th>
                                    <th class="p-2 text-center">Damaged</th>
                                    <th class="p-2 text-center">Short</th>
                                    <th class="p-2 text-center">Received</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transfer.items.map((item, index) => {
                                    const dispatched = item.quantity_sent || 0;
                                    const damaged = item.quantity_damaged || 0;
                                    const short = item.quantity_short || 0;
                                    const received = dispatched - damaged - short;
                                    return `
                                    <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                                        <td class="p-2 border">${index + 1}</td>
                                        <td class="p-2 border">${item.code}</td>
                                        <td class="p-2 border font-semibold">${item.name}</td>
                                        <td class="p-2 border text-center">${dispatched}</td>
                                        <td class="p-2 border text-center">${item.product_type || '-'}</td>
                                        <td class="p-2 border text-center">${item.unit}</td>
                                        <td class="p-2 border text-center" style="${damaged > 0 ? 'color: #DC2626; font-weight: bold;' : ''}">${damaged || '-'}</td>
                                        <td class="p-2 border text-center" style="${short > 0 ? 'color: #D97706; font-weight: bold;' : ''}">${short || '-'}</td>
                                        <td class="p-2 border text-center font-semibold">${item.quantity_received !== undefined ? received : '-'}</td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                        
                        ${transfer.status === 'received' ? `
                            <div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-left: 4px solid #DC2626; border-radius: 0.375rem;">
                                <div style="font-weight: bold; margin-bottom: 0.75rem; font-size: 1rem;">Transfer Summary</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6B7280;">Total Dispatched</div>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #1F2937;">${transfer.items.reduce((sum, item) => sum + (item.quantity_sent || 0), 0)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6B7280;">Total Damaged</div>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #DC2626;">${transfer.items.reduce((sum, item) => sum + (item.quantity_damaged || 0), 0)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6B7280;">Total Short</div>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #D97706;">${transfer.items.reduce((sum, item) => sum + (item.quantity_short || 0), 0)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6B7280;">Total Received</div>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${transfer.items.reduce((sum, item) => {
                                            const dispatched = item.quantity_sent || 0;
                                            const damaged = item.quantity_damaged || 0;
                                            const short = item.quantity_short || 0;
                                            const received = dispatched - damaged - short;
                                            return sum + received;
                                        }, 0)}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button onclick="printSingleTransfer('${transfer.id}')" class="btn btn-primary">
                            üñ®Ô∏è Print Document
                        </button>
                        ${transfer.status === 'pending' ? `
                            <button onclick="dispatchTransfer('${transfer.id}')" class="btn btn-success">
                                üì§ Dispatch Transfer
                            </button>
                        ` : ''}
                        ${transfer.status === 'in_transit' ? `
                            <button onclick="receiveTransfer('${transfer.id}')" class="btn btn-success">
                                ‚úÖ Confirm Receipt
                            </button>
                        ` : ''}
                        <button onclick="closeModal('transferDetailsModal')" class="btn btn-secondary">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('transferDetailsContent').innerHTML = html;
            document.getElementById('transferDetailsModal').classList.remove('hidden');
        }

        // Print Single Transfer
        function printSingleTransfer(id) {
            const transfer = DB.transfers.find(t => t.id === id);
            if (!transfer) return;

            const printArea = document.getElementById('printArea');
            
            const logoHtml = DB.companyLogo ? 
                `<img src="${DB.companyLogo}" alt="Logo" class="print-logo">` : '';

            printArea.innerHTML = `
                <div class="print-document">
                    <div class="print-header">
                        <div class="print-header-left">
                            ${logoHtml}
                            <h1 class="print-company-name">FAIRFIELD MEAT CENTRE</h1>
                            <p class="print-subtitle">Stock Transfer Document</p>
                        </div>
                        <div class="print-header-right">
                            <div class="print-transfer-id">${transfer.transfer_id}</div>
                            <div class="print-barcode">
                                <svg id="transferBarcode"></svg>
                            </div>
                        </div>
                    </div>

                    <div class="print-info-grid">
                        <div class="print-section">
                            <div class="print-section-title">Dispatched Details</div>
                            <div class="print-info-row">
                                <span class="print-info-label">Dispatched:</span>
                                <span>${transfer.dispatched_at ? formatDateTime(transfer.dispatched_at) : 'Pending'}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">From:</span>
                                <span>${transfer.from_location}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Dispatched By:</span>
                                <span>${getUserNameFromEmail(transfer.dispatched_by || transfer.created_by)}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Created:</span>
                                <span>${formatDateTime(transfer.created_at)}</span>
                            </div>
                        </div>

                        <div class="print-section">
                            <div class="print-section-title">Delivery Details</div>
                            <div class="print-info-row">
                                <span class="print-info-label">To:</span>
                                <span>${transfer.to_location}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Vehicle Reg. Number:</span>
                                <span>${transfer.vehicle || '-'}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Driver:</span>
                                <span>${transfer.driver_name || transfer.driver || '-'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="print-items-section">
                        <div class="print-items-title">Items</div>
                        <table class="print-items-table">
                            <thead>
                                <tr>
                                    <th style="width: 4%;">#</th>
                                    <th style="width: 12%;">Code</th>
                                    <th style="width: 35%;">Product</th>
                                    <th style="width: 9%;">Dispatched</th>
                                    <th style="width: 9%;">Type</th>
                                    <th style="width: 8%;">Unit</th>
                                    <th style="width: 8%;">Damaged</th>
                                    <th style="width: 7%;">Short</th>
                                    <th style="width: 8%;">Received</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transfer.items.map((item, index) => {
                                    const dispatched = item.quantity_sent || 0;
                                    const damaged = item.quantity_damaged || 0;
                                    const short = item.quantity_short || 0;
                                    const received = dispatched - damaged - short;
                                    return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${item.code}</td>
                                        <td>${item.name}</td>
                                        <td style="text-align: center;">${dispatched}</td>
                                        <td style="text-align: center;">${item.product_type || '-'}</td>
                                        <td style="text-align: center;">${item.unit}</td>
                                        <td style="text-align: center; ${damaged > 0 ? 'color: #DC2626; font-weight: bold;' : ''}">${damaged || '-'}</td>
                                        <td style="text-align: center; ${short > 0 ? 'color: #D97706; font-weight: bold;' : ''}">${short || '-'}</td>
                                        <td style="text-align: center; font-weight: bold;">${item.quantity_received !== undefined ? received : ''}</td>
                                    </tr>
                                `}).join('')}
                                ${Array(Math.max(0, 25 - transfer.items.length)).fill(0).map(() => `
                                    <tr>
                                        <td>&nbsp;</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        ${transfer.status === 'received' ? `
                            <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-left: 3px solid #DC2626;">
                                <div style="font-size: 8pt; font-weight: bold; margin-bottom: 3px;">TRANSFER SUMMARY</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 7.5pt;">
                                    <div>
                                        <span style="font-weight: bold;">Total Dispatched:</span>
                                        <span style="font-weight: bold; margin-left: 4px;">${transfer.items.reduce((sum, item) => sum + (item.quantity_sent || 0), 0)}</span>
                                    </div>
                                    <div style="color: #DC2626;">
                                        <span style="font-weight: bold;">Total Damaged:</span>
                                        <span style="font-weight: bold; margin-left: 4px;">${transfer.items.reduce((sum, item) => sum + (item.quantity_damaged || 0), 0)}</span>
                                    </div>
                                    <div style="color: #D97706;">
                                        <span style="font-weight: bold;">Total Short:</span>
                                        <span style="font-weight: bold; margin-left: 4px;">${transfer.items.reduce((sum, item) => sum + (item.quantity_short || 0), 0)}</span>
                                    </div>
                                    <div style="color: #059669;">
                                        <span style="font-weight: bold;">Total Received:</span>
                                        <span style="font-weight: bold; margin-left: 4px;">${transfer.items.reduce((sum, item) => {
                                            const dispatched = item.quantity_sent || 0;
                                            const damaged = item.quantity_damaged || 0;
                                            const short = item.quantity_short || 0;
                                            const received = dispatched - damaged - short;
                                            return sum + received;
                                        }, 0)}</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="print-signatures">
                        <div class="print-signature-box">
                            <div class="print-signature-title">DISPATCHER SIGNATURE</div>
                            <div class="print-signature-line"></div>
                            <div class="print-signature-info">
                                <div>Name: ${getUserNameFromEmail(transfer.dispatched_by || transfer.created_by)}</div>
                                <div>Date: ${transfer.dispatched_at ? formatDate(transfer.dispatched_at) : formatDate(transfer.created_at)}</div>
                            </div>
                        </div>
                        <div class="print-signature-box">
                            <div class="print-signature-title">RECEIVER SIGNATURE</div>
                            <div class="print-signature-line"></div>
                            <div class="print-signature-info">
                                <div>Name: ${getUserNameFromEmail(transfer.received_by) || ''}</div>
                                <div>Date: ${transfer.received_at ? formatDate(transfer.received_at) : ''}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Generate barcode
            try {
                JsBarcode('#transferBarcode', transfer.transfer_id, {
                    format: 'CODE128',
                    width: 1.5,
                    height: 35,
                    displayValue: false,
                    fontSize: 10
                });
            } catch (e) {
                console.error('Error generating barcode:', e);
            }

            printArea.style.display = 'block';
            
            // Delay print to ensure content is rendered on all devices (mobile/tablet compatibility)
            setTimeout(() => {
                window.print();
                // Reset after print dialog closes
                setTimeout(() => {
                    printArea.style.display = 'none';
                }, 500);
            }, 100);
        }

        // Reports Functions
        function showReportSection(type) {
            document.getElementById('customReportSection').classList.add('hidden');
            document.getElementById('monthlyReportSection').classList.add('hidden');
            document.getElementById('detailedReportSection').classList.add('hidden');
            
            if (type === 'custom') {
                document.getElementById('customReportSection').classList.remove('hidden');
            } else if (type === 'monthly') {
                document.getElementById('monthlyReportSection').classList.remove('hidden');
            } else if (type === 'detailed') {
                document.getElementById('detailedReportSection').classList.remove('hidden');
            }
        }
        
        function generateCustomReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                alert('Please select both from and to dates');
                return;
            }
            
            const filtered = DB.transfers.filter(t => {
                const transferDate = new Date(t.created_at);
                return transferDate >= new Date(fromDate) && transferDate <= new Date(toDate);
            });
            
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = `
                <div class="transfer-document">
                    <div class="doc-header">
                        ${DB.companyLogo ? `<img src="${DB.companyLogo}" alt="Logo" style="max-width: 150px; max-height: 80px; margin: 0 auto 10px;">` : ''}
                        <div class="doc-title">FAIRFIELD STOCK CONTROL</div>
                        <div class="doc-subtitle">Transfer Report: ${fromDate} to ${toDate}</div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">Summary</h3>
                        <p>Total Transfers: ${filtered.length}</p>
                        <p>Pending: ${filtered.filter(t => t.status === 'pending').length}</p>
                        <p>In Transit: ${filtered.filter(t => t.status === 'in_transit').length}</p>
                        <p>Received: ${filtered.filter(t => t.status === 'received').length}</p>
                    </div>
                    
                    <table class="doc-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #333; color: white;">
                                <th style="padding: 8px; border: 1px solid #ddd;">Transfer ID</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">From</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">To</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Items</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Status</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(t => `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${t.transfer_id}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${t.from_location}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${t.to_location}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${t.items.length}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${t.status}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${formatDate(t.created_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            printArea.style.display = 'block';
            
            // Delay print to ensure content is rendered on all devices (mobile/tablet compatibility)
            setTimeout(() => {
                window.print();
                // Reset after print dialog closes
                setTimeout(() => {
                    printArea.style.display = 'none';
                }, 500);
            }, 100);
        }

        function generateMonthlyBranchReport() {
            const monthInput = document.getElementById('monthlyReportMonth').value;
            if (!monthInput) {
                alert('Please select a month');
                return;
            }
            
            const [year, month] = monthInput.split('-');
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            
            const monthlyTransfers = DB.transfers.filter(t => {
                const transferDate = new Date(t.created_at);
                return transferDate >= startDate && transferDate <= endDate && t.status === 'received';
            });
            
            // Calculate totals per branch and overall totals
            const branchData = {};
            const overallProducts = {};
            let overallDamaged = 0;
            let overallShort = 0;
            
            monthlyTransfers.forEach(t => {
                if (!branchData[t.to_location]) {
                    branchData[t.to_location] = {
                        transferCount: 0,
                        products: {},
                        totalDamaged: 0,
                        totalShort: 0
                    };
                }
                branchData[t.to_location].transferCount++;
                
                t.items.forEach(item => {
                    const quantity = parseInt(item.quantity_received || item.quantity_sent);
                    const damaged = parseInt(item.quantity_damaged || 0);
                    const short = parseInt(item.quantity_short || 0);
                    
                    // Add to overall damaged and short
                    overallDamaged += damaged;
                    overallShort += short;
                    branchData[t.to_location].totalDamaged += damaged;
                    branchData[t.to_location].totalShort += short;
                    
                    // Branch totals
                    if (!branchData[t.to_location].products[item.name]) {
                        branchData[t.to_location].products[item.name] = {
                            quantity: 0,
                            damaged: 0,
                            short: 0,
                            unit: item.unit
                        };
                    }
                    branchData[t.to_location].products[item.name].quantity += quantity;
                    branchData[t.to_location].products[item.name].damaged += damaged;
                    branchData[t.to_location].products[item.name].short += short;
                    
                    // Overall totals
                    if (!overallProducts[item.name]) {
                        overallProducts[item.name] = {
                            quantity: 0,
                            damaged: 0,
                            short: 0,
                            unit: item.unit
                        };
                    }
                    overallProducts[item.name].quantity += quantity;
                    overallProducts[item.name].damaged += damaged;
                    overallProducts[item.name].short += short;
                });
            });
            
            const html = `
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-6">Monthly Report for ${new Date(year, month - 1).toLocaleDateString('en-ZA', { year: 'numeric', month: 'long' })}</h3>
                    
                    <!-- OVERALL MONTHLY TOTAL FIRST -->
                    <div class="border-2 border-primary-red rounded-lg p-6 mb-6" style="background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);">
                        <h4 class="font-bold text-2xl mb-4" style="color: #DC2626;">üìä WHOLE MONTH TOTAL</h4>
                        <p class="text-sm text-gray-700 mb-4 font-semibold">Total Transfers: ${monthlyTransfers.length} | Total Branches: ${Object.keys(branchData).length}</p>
                        
                        <!-- Damaged & Short Summary -->
                        <div class="grid-3 gap-4 mb-4" style="background: white; padding: 1rem; border-radius: 0.5rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.5rem;">Total Received</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${Object.values(overallProducts).reduce((sum, p) => sum + p.quantity, 0)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.5rem;">Total Damaged</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #DC2626;">${overallDamaged}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.5rem;">Total Short</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #D97706;">${overallShort}</div>
                            </div>
                        </div>
                        
                        <table class="w-full text-sm" style="background: white; border-radius: 0.5rem; overflow: hidden;">
                            <thead>
                                <tr style="background: #DC2626; color: white;">
                                    <th class="p-3 text-left">Product</th>
                                    <th class="p-3 text-right">Received</th>
                                    <th class="p-3 text-right">Damaged</th>
                                    <th class="p-3 text-right">Short</th>
                                    <th class="p-3 text-right">Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(overallProducts).map(([product, info]) => `
                                    <tr class="border-t">
                                        <td class="p-3 font-semibold">${product}</td>
                                        <td class="p-3 text-right font-bold" style="color: #059669;">${info.quantity}</td>
                                        <td class="p-3 text-right font-bold" style="color: #DC2626;">${info.damaged > 0 ? info.damaged : '-'}</td>
                                        <td class="p-3 text-right font-bold" style="color: #D97706;">${info.short > 0 ? info.short : '-'}</td>
                                        <td class="p-3 text-right">${info.unit}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- BRANCH BREAKDOWN -->
                    <h4 class="font-bold text-xl mb-4">Branch Breakdown</h4>
                    ${Object.keys(branchData).length > 0 ? Object.entries(branchData).map(([branch, data]) => `
                        <div class="border rounded-lg p-4 mb-4" style="background: #F9FAFB;">
                            <h5 class="font-bold text-lg mb-2">${branch}</h5>
                            <p class="text-sm text-gray-600 mb-3">Total Transfers Received: ${data.transferCount} | Damaged: ${data.totalDamaged} | Short: ${data.totalShort}</p>
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="p-2 text-left">Product</th>
                                        <th class="p-2 text-right">Received</th>
                                        <th class="p-2 text-right">Damaged</th>
                                        <th class="p-2 text-right">Short</th>
                                        <th class="p-2 text-right">Unit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data.products).map(([product, info]) => `
                                        <tr class="border-t">
                                            <td class="p-2">${product}</td>
                                            <td class="p-2 text-right font-semibold">${info.quantity}</td>
                                            <td class="p-2 text-right" style="color: #DC2626;">${info.damaged > 0 ? info.damaged : '-'}</td>
                                            <td class="p-2 text-right" style="color: #D97706;">${info.short > 0 ? info.short : '-'}</td>
                                            <td class="p-2 text-right">${info.unit}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `).join('') : '<p class="text-gray-500">No transfers received in this month</p>'}
                </div>
            `;
            
            document.getElementById('monthlyBranchReport').innerHTML = html;
        }

        function generateDetailedReport() {
            const monthInput = document.getElementById('detailedReportMonth').value;
            if (!monthInput) {
                alert('Please select a month');
                return;
            }
            
            const [year, month] = monthInput.split('-');
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            
            const monthlyTransfers = DB.transfers.filter(t => {
                const transferDate = new Date(t.created_at);
                return transferDate >= startDate && transferDate <= endDate;
            });
            
            // Detailed analytics
            const analytics = {
                totalTransfers: monthlyTransfers.length,
                pending: monthlyTransfers.filter(t => t.status === 'pending').length,
                inTransit: monthlyTransfers.filter(t => t.status === 'in_transit').length,
                received: monthlyTransfers.filter(t => t.status === 'received').length,
                byLocation: {},
                topProducts: {},
                totalDamaged: 0,
                totalShort: 0
            };
            
            monthlyTransfers.forEach(t => {
                // By location
                if (!analytics.byLocation[t.to_location]) {
                    analytics.byLocation[t.to_location] = { count: 0, items: 0 };
                }
                analytics.byLocation[t.to_location].count++;
                analytics.byLocation[t.to_location].items += t.items.length;
                
                // Top products
                t.items.forEach(item => {
                    if (!analytics.topProducts[item.name]) {
                        analytics.topProducts[item.name] = 0;
                    }
                    analytics.topProducts[item.name] += parseInt(item.quantity_sent || 0);
                    
                    if (t.status === 'received') {
                        analytics.totalDamaged += parseInt(item.quantity_damaged || 0);
                        analytics.totalShort += parseInt(item.quantity_short || 0);
                    }
                });
            });
            
            // Sort top products
            const topProducts = Object.entries(analytics.topProducts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const html = `
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-6">Detailed Analytics for ${new Date(year, month - 1).toLocaleDateString('en-ZA', { year: 'numeric', month: 'long' })}</h3>
                    
                    <!-- Summary Cards -->
                    <div class="grid-4 gap-4 mb-6">
                        <div class="border rounded-lg p-4" style="background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%); color: white;">
                            <div class="text-sm opacity-90">Total Transfers</div>
                            <div class="text-3xl font-bold">${analytics.totalTransfers}</div>
                        </div>
                        <div class="border rounded-lg p-4" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white;">
                            <div class="text-sm opacity-90">Pending</div>
                            <div class="text-3xl font-bold">${analytics.pending}</div>
                        </div>
                        <div class="border rounded-lg p-4" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%); color: white;">
                            <div class="text-sm opacity-90">In Transit</div>
                            <div class="text-3xl font-bold">${analytics.inTransit}</div>
                        </div>
                        <div class="border rounded-lg p-4" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white;">
                            <div class="text-sm opacity-90">Received</div>
                            <div class="text-3xl font-bold">${analytics.received}</div>
                        </div>
                    </div>
                    
                    <div class="grid-2 gap-6 mb-6">
                        <!-- By Location -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-bold text-lg mb-4">Transfers by Location</h4>
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-2 text-left">Location</th>
                                        <th class="p-2 text-right">Transfers</th>
                                        <th class="p-2 text-right">Items</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(analytics.byLocation).map(([location, data]) => `
                                        <tr class="border-t">
                                            <td class="p-2">${location}</td>
                                            <td class="p-2 text-right font-semibold">${data.count}</td>
                                            <td class="p-2 text-right">${data.items}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Top Products -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-bold text-lg mb-4">Top 10 Products</h4>
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-2 text-left">Product</th>
                                        <th class="p-2 text-right">Total Quantity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topProducts.map(([product, quantity]) => `
                                        <tr class="border-t">
                                            <td class="p-2">${product}</td>
                                            <td class="p-2 text-right font-semibold">${quantity}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Quality Metrics -->
                    <div class="border rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-4">Quality Metrics</h4>
                        <div class="grid-2 gap-4">
                            <div class="p-4 rounded" style="background: #FEE2E2;">
                                <div class="text-sm text-gray-700">Total Damaged Items</div>
                                <div class="text-2xl font-bold" style="color: #DC2626;">${analytics.totalDamaged}</div>
                            </div>
                            <div class="p-4 rounded" style="background: #FEF3C7;">
                                <div class="text-sm text-gray-700">Total Short Items</div>
                                <div class="text-2xl font-bold" style="color: #D97706;">${analytics.totalShort}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detailedReportContent').innerHTML = html;
        }

        function renderTransferHistory() {
            const recent = DB.transfers.slice(0, 50);
            
            const html = `
                <table class="text-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Transfer ID</th>
                            <th>From ‚Üí To</th>
                            <th>Items</th>
                            <th>Status</th>
                            <th>Driver</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recent.map(t => `
                            <tr>
                                <td>${formatDateTime(t.created_at)}</td>
                                <td><strong>${t.transfer_id}</strong></td>
                                <td>${t.from_location} ‚Üí ${t.to_location}</td>
                                <td>${t.items.length}</td>
                                <td>${getStatusBadge(t.status)}</td>
                                <td>${t.driver_name}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('transferHistory').innerHTML = html;
        }

        function renderReturnsByBranch() {
            // Group returns by branch/location
            const returnsByBranch = {};
            
            DB.returns.forEach(r => {
                const location = r.location || 'Unknown';
                if (!returnsByBranch[location]) {
                    returnsByBranch[location] = {
                        count: 0,
                        totalQuantity: 0,
                        items: []
                    };
                }
                returnsByBranch[location].count++;
                returnsByBranch[location].totalQuantity += r.quantity || 0;
                returnsByBranch[location].items.push(r);
            });
            
            // Convert to array and sort by count (descending)
            const branchArray = Object.keys(returnsByBranch).map(branch => ({
                branch: branch,
                count: returnsByBranch[branch].count,
                totalQuantity: returnsByBranch[branch].totalQuantity
            })).sort((a, b) => b.count - a.count);
            
            if (branchArray.length === 0) {
                document.getElementById('returnsByBranchContent').innerHTML = 
                    '<p class="text-center text-gray-500 py-8">No returns logged yet</p>';
                return;
            }
            
            const html = `
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Branch Location</th>
                                <th class="text-center">Total Returns Logged</th>
                                <th class="text-center">Total Items Returned</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${branchArray.map(branch => `
                                <tr>
                                    <td><strong>${branch.branch}</strong></td>
                                    <td class="text-center"><span class="status-badge status-pending">${branch.count}</span></td>
                                    <td class="text-center"><strong>${branch.totalQuantity}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="background: #F3F4F6; font-weight: bold;">
                                <td>TOTAL</td>
                                <td class="text-center">${branchArray.reduce((sum, b) => sum + b.count, 0)}</td>
                                <td class="text-center">${branchArray.reduce((sum, b) => sum + b.totalQuantity, 0)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            document.getElementById('returnsByBranchContent').innerHTML = html;
        }

        // Product Report Download
        function downloadProductReport() {
            let csv = 'Product Code,Product Name,Category,Unit\n';
            DB.products.forEach(p => {
                csv += `${p.code},${p.name},${p.category || '-'},${p.unit}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `products_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Transfer Item Management
        function addTransferItem() {
            transferItemCount++;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'transfer-item';
            itemDiv.innerHTML = `
                <div>
                    <label>Product</label>
                    <select class="item-product" required>
                        <option value="">Select product...</option>
                        ${DB.products.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label>Quantity</label>
                    <input type="number" class="item-quantity" min="1" required>
                </div>
                <div>
                    <label>Product Type</label>
                    <select class="item-product-type" required>
                        <option value="kg">Kilograms (kg)</option>
                        <option value="units">Units</option>
                        <option value="boxes">Boxes</option>
                        <option value="grams">Grams</option>
                        <option value="litres">Litres</option>
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="btn-action btn-action-delete w-full">Remove</button>
                </div>
            `;
            document.getElementById('transferItems').appendChild(itemDiv);
        }

        function filterTransferProductDropdowns() {
            const searchTerm = document.getElementById('transferProductSearchFilter')?.value.toLowerCase() || '';
            const selects = document.querySelectorAll('.item-product');
            
            selects.forEach(select => {
                const currentValue = select.value;
                
                if (searchTerm.length === 0) {
                    // Show all products
                    select.innerHTML = '<option value="">Select product...</option>' +
                        DB.products.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
                } else {
                    // Filter products
                    const filtered = DB.products.filter(p => 
                        p.name.toLowerCase().includes(searchTerm) ||
                        p.code.toLowerCase().includes(searchTerm)
                    );
                    
                    select.innerHTML = '<option value="">Select product...</option>' +
                        filtered.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
                }
                
                // Restore selection if it still exists
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        function populateProductSelects() {
            const selects = document.querySelectorAll('.item-product');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select product...</option>' +
                    DB.products.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            });
        }

        // Form Handlers
        document.addEventListener('DOMContentLoaded', function() {
            const addProductForm = document.getElementById('addProductForm');
            if (addProductForm) {
                addProductForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const product = {
                        code: document.getElementById('productCode').value,
                        name: document.getElementById('productName').value,
                        category: document.getElementById('productCategory').value,
                        unit: document.getElementById('productUnit').value,
                        created_at: new Date().toISOString()
                    };
                    
                    try {
                        const { addDoc, collection } = window.firebaseModules;
                        await addDoc(collection(window.db, 'products'), product);
                        await loadProducts();
                        closeModal('addProductModal');
                        addProductForm.reset();
                        alert('Product added successfully!');
                    } catch (error) {
                        alert('Error adding product: ' + error.message);
                    }
                });
            }

            const addLocationForm = document.getElementById('addLocationForm');
            if (addLocationForm) {
                addLocationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const location = {
                        name: document.getElementById('locationName').value,
                        address: document.getElementById('locationAddress').value,
                        created_at: new Date().toISOString()
                    };
                    
                    try {
                        const { addDoc, collection } = window.firebaseModules;
                        await addDoc(collection(window.db, 'locations'), location);
                        await loadLocations();
                        closeModal('addLocationModal');
                        addLocationForm.reset();
                        alert('Location added successfully!');
                    } catch (error) {
                        alert('Error adding location: ' + error.message);
                    }
                });
            }

            const editLocationForm = document.getElementById('editLocationForm');
            if (editLocationForm) {
                editLocationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const id = document.getElementById('editLocationId').value;
                    const locationData = {
                        name: document.getElementById('editLocationName').value,
                        address: document.getElementById('editLocationAddress').value
                    };
                    
                    try {
                        const { updateDoc, doc } = window.firebaseModules;
                        await updateDoc(doc(window.db, 'locations', id), locationData);
                        await loadLocations();
                        closeModal('editLocationModal');
                        alert('Location updated successfully!');
                    } catch (error) {
                        alert('Error updating location: ' + error.message);
                    }
                });
            }

            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('userName').value;
                    const email = document.getElementById('newUserEmail').value;
                    const password = document.getElementById('userPassword').value;
                    const role = document.getElementById('userRole').value;
                    
                    // Validate inputs
                    if (!name || !email || !password) {
                        alert('Please fill in all fields');
                        return;
                    }
                    
                    try {
                        const { createUserWithEmailAndPassword } = window.firebaseModules;
                        const { addDoc, collection } = window.firebaseModules;
                        
                        const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
                        
                        await addDoc(collection(window.db, 'users'), {
                            name: name,
                            email: email,
                            role: role,
                            permissions: getRolePermissions(role),
                            created_at: new Date().toISOString()
                        });
                        
                        await loadUsers();
                        closeModal('addUserModal');
                        addUserForm.reset();
                        alert('User added successfully!');
                    } catch (error) {
                        alert('Error adding user: ' + error.message);
                    }
                });
            }

            const transferForm = document.getElementById('transferForm');
            if (transferForm) {
                transferForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const items = [];
                    document.querySelectorAll('.transfer-item').forEach(itemDiv => {
                        const productSelect = itemDiv.querySelector('.item-product');
                        const quantityInput = itemDiv.querySelector('.item-quantity');
                        const productTypeSelect = itemDiv.querySelector('.item-product-type');
                        
                        if (productSelect && productSelect.value && quantityInput && quantityInput.value) {
                            const product = DB.products.find(p => p.id === productSelect.value);
                            
                            // Only add if product exists
                            if (product && product.id) {
                                items.push({
                                    product_id: product.id || '',
                                    code: product.code || '',
                                    name: product.name || '',
                                    unit: product.unit || 'pieces',
                                    product_type: (productTypeSelect && productTypeSelect.value) ? productTypeSelect.value : 'units',
                                    quantity_sent: parseInt(quantityInput.value) || 0
                                });
                            }
                        }
                    });
                    
                    if (items.length === 0) {
                        alert('Please add at least one product');
                        return;
                    }
                    
                    const fromLocationSelect = document.getElementById('fromLocation');
                    const toLocationSelect = document.getElementById('toLocation');
                    const driverNameSelect = document.getElementById('driverName');
                    const vehicleRegInput = document.getElementById('vehicleReg');
                    
                    // Validate all required fields exist and have values
                    if (!fromLocationSelect.value || !toLocationSelect.value) {
                        alert('Please select both From and To locations');
                        return;
                    }
                    
                    if (!driverNameSelect.value || !vehicleRegInput.value) {
                        alert('Please select driver and enter vehicle registration');
                        return;
                    }
                    
                    const transfer = {
                        transfer_id: 'TRF' + Date.now(),
                        from_location: fromLocationSelect.selectedOptions[0]?.text || '',
                        to_location: toLocationSelect.selectedOptions[0]?.text || '',
                        driver_name: driverNameSelect.value || '',
                        vehicle: vehicleRegInput.value || '',
                        items: items || [],
                        status: 'pending',
                        created_at: new Date().toISOString(),
                        created_by: DB.currentUser?.email || 'unknown'
                    };
                    
                    // Validate no undefined values before saving
                    for (const key in transfer) {
                        if (transfer[key] === undefined) {
                            throw new Error(`Field '${key}' is undefined`);
                        }
                        if (Array.isArray(transfer[key])) {
                            transfer[key].forEach((item, idx) => {
                                for (const itemKey in item) {
                                    if (item[itemKey] === undefined) {
                                        throw new Error(`Field 'items[${idx}].${itemKey}' is undefined`);
                                    }
                                }
                            });
                        }
                    }
                    
                    try {
                        const { addDoc, collection } = window.firebaseModules;
                        console.log('Saving transfer:', transfer);
                        await addDoc(collection(window.db, 'transfers'), transfer);
                        await loadTransfers();
                        transferForm.reset();
                        document.getElementById('transferItems').innerHTML = '';
                        transferItemCount = 0;
                        alert('Transfer created successfully!');
                        showSection('allTransfers');
                    } catch (error) {
                        alert('Error creating transfer: ' + error.message);
                    }
                });
            }
        });

        function populateLocationSelects() {
            ['fromLocation', 'toLocation'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Select location...</option>' +
                        DB.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                }
            });
        }
        
        function populateDriverSelect() {
            const driverSelect = document.getElementById('driverName');
            if (driverSelect) {
                driverSelect.innerHTML = '<option value="">Select Driver...</option>' +
                    DB.drivers.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
            }
        }

        function updateDashboard() {
            document.getElementById('statProducts').textContent = DB.products.length;
            document.getElementById('statLocations').textContent = DB.locations.length;
            document.getElementById('statPending').textContent = DB.transfers.filter(t => t.status === 'pending').length;
            document.getElementById('statTransit').textContent = DB.transfers.filter(t => t.status === 'in_transit').length;
        }

        // User Management Functions
        function getRolePermissions(role) {
            const permissions = {
                admin: {
                    view_dashboard: true,
                    view_transfers: true,
                    create_transfers: true,
                    dispatch_transfers: true,
                    receive_transfers: true,
                    view_products: true,
                    add_products: true,
                    edit_products: true,
                    delete_products: true,
                    add_locations: true,
                    edit_locations: true,
                    manage_users: true,
                    generate_reports: true,
                    access_settings: true
                },
                dispatch: {
                    view_dashboard: true,
                    view_transfers: true,
                    create_transfers: true,
                    dispatch_transfers: true,
                    view_products: true,
                    add_products: true,
                    generate_reports: true
                },
                receiver: {
                    view_dashboard: true,
                    view_transfers: true,
                    receive_transfers: true,
                    view_products: true,
                    generate_reports: true
                },
                view_only: {
                    view_dashboard: true,
                    view_transfers: true,
                    view_products: true,
                    generate_reports: true
                }
            };
            return permissions[role] || {};
        }

        function updateEditRolePermissions() {
            const role = document.getElementById('editUserRole').value;
            const permissions = getRolePermissions(role);
            
            // Update all checkboxes based on role permissions
            ['view_transfers', 'create_transfers', 'dispatch_transfers', 'receive_transfers',
             'view_products', 'add_products', 'edit_products', 'delete_products',
             'manage_users', 'generate_reports', 'access_settings'].forEach(perm => {
                const checkbox = document.getElementById('edit_perm_' + perm);
                if (checkbox) {
                    checkbox.checked = permissions[perm] || false;
                }
            });
        }
        
        function editUser(userId) {
            const user = DB.users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = userId;
            const displayName = user.name || user.email.split('@')[0];
            document.getElementById('editUserName').textContent = displayName;
            document.getElementById('editUserRole').value = user.role || 'view_only';
            
            // Set permissions
            const perms = user.permissions || {};
            Object.keys(perms).forEach(key => {
                const checkbox = document.getElementById('edit_perm_' + key);
                if (checkbox) checkbox.checked = perms[key];
            });
            
            document.getElementById('editUserPermissionsModal').classList.remove('hidden');
        }

        async function deleteUser(id) {
            if (!hasPermission('manage_users')) {
                alert('You do not have permission to delete users');
                return;
            }
            
            const user = DB.users.find(u => u.id === id);
            if (!user) return;
            
            const displayName = user.name || user.email;
            if (!confirm(`Delete user "${displayName}"? This action cannot be undone.`)) return;
            
            try {
                const { deleteDoc, doc } = window.firebaseModules;
                await deleteDoc(doc(window.db, 'users', id));
                await loadUsers();
                alert('User deleted successfully!');
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            }
        }

        // Add event listener for edit user permissions form
        document.addEventListener('DOMContentLoaded', function() {
            const editUserForm = document.getElementById('editUserPermissionsForm');
            if (editUserForm) {
                editUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const { updateDoc, doc } = window.firebaseModules;
                        const userId = document.getElementById('editUserId').value;
                        const role = document.getElementById('editUserRole').value;
                        
                        // Get permissions
                        const permissions = {};
                        ['view_transfers', 'create_transfers', 'dispatch_transfers', 'receive_transfers',
                         'view_products', 'add_products', 'edit_products', 'delete_products',
                         'manage_users', 'generate_reports', 'access_settings'].forEach(perm => {
                            const checkbox = document.getElementById('edit_perm_' + perm);
                            if (checkbox) permissions[perm] = checkbox.checked;
                        });
                        
                        await updateDoc(doc(window.db, 'users', userId), {
                            role: role,
                            permissions: permissions,
                            updated_at: new Date().toISOString()
                        });
                        
                        // If editing current user, update their session
                        if (DB.currentUser && DB.currentUser.id === userId) {
                            DB.currentUser.role = role;
                            DB.currentUser.permissions = permissions;
                        }
                        
                        closeModal('editUserPermissionsModal');
                        await loadUsers();
                        alert('User permissions updated successfully!');
                    } catch (error) {
                        console.error('Error updating user:', error);
                        alert('Failed to update user permissions');
                    }
                });
            }
        });

        // Utility Functions
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.onclick && item.onclick.toString().includes(section)) {
                    item.classList.add('active');
                }
            });
            
            currentPage = 1;
            
            if (section === 'reports') {
                renderTransferHistory();
                renderReturnsByBranch();
            } else if (section === 'products') {
                currentPageType = 'products';
                filterProducts(true);
            } else if (section === 'allTransfers') {
                currentPageType = 'allTransfers';
            } else if (section === 'dispatch') {
                currentPageType = 'dispatch';
            } else if (section === 'receive') {
                currentPageType = 'receive';
            } else if (section === 'returns') {
                renderReturns();
                updateReturnsStats();
            }
        }

        function showAddProductModal() {
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function showAddLocationModal() {
            document.getElementById('addLocationModal').classList.remove('hidden');
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
            updatePermissionOptions();
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            loadCompanyLogo();
        }

        function showMainApp() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Hide admin-only sections for non-admin users
            const isAdmin = DB.currentUser && DB.currentUser.role === 'admin';
            const usersNavItem = document.getElementById('usersNavItem');
            const settingsNavItem = document.getElementById('settingsNavItem');
            
            if (usersNavItem) {
                usersNavItem.style.display = isAdmin ? 'block' : 'none';
            }
            if (settingsNavItem) {
                settingsNavItem.style.display = isAdmin ? 'block' : 'none';
            }
            
            // Initialize return form listeners
            initializeReturnFormListeners();
        }

        function formatDate(date) {
            if (!date) return '-';
            return new Date(date).toLocaleDateString('en-ZA');
        }

        function formatDateTime(date) {
            if (!date) return '-';
            const d = new Date(date);
            return d.toLocaleDateString('en-ZA') + ' ' + d.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
        }

        function getUserNameFromEmail(email) {
            if (!email) return '-';
            const user = DB.users.find(u => u.email === email);
            return user && user.name ? user.name : email.split('@')[0];
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="status-badge status-pending">Pending</span>',
                'in_transit': '<span class="status-badge status-transit">In Transit</span>',
                'received': '<span class="status-badge status-received">Received</span>'
            };
            return badges[status] || status;
        }

        function getRoleBadge(role) {
            const badges = {
                'admin': '<span class="role-badge role-admin">Admin</span>',
                'dispatch': '<span class="role-badge role-dispatch">Dispatch</span>',
                'receiver': '<span class="role-badge role-receiver">Receiver</span>',
                'view_only': '<span class="role-badge role-view-only">View Only</span>'
            };
            return badges[role] || role;
        }

        function updatePermissionOptions() {
            document.getElementById('permissionsList').innerHTML = '<p class="text-sm text-gray-600">Permissions are set based on role</p>';
        }

        function hasPermission(permission) {
            return DB.currentUser && DB.currentUser.permissions && DB.currentUser.permissions[permission];
        }

        function editProduct(id) {
            const product = DB.products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('editProductId').value = id;
            document.getElementById('editProductCode').value = product.code;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductCategory').value = product.category || '';
            document.getElementById('editProductUnit').value = product.unit;

            document.getElementById('editProductModal').classList.remove('hidden');
        }

        async function handleEditProduct(event) {
            event.preventDefault();

            const id = document.getElementById('editProductId').value;
            const productData = {
                code: document.getElementById('editProductCode').value,
                name: document.getElementById('editProductName').value,
                category: document.getElementById('editProductCategory').value,
                unit: document.getElementById('editProductUnit').value
            };

            try {
                const { updateDoc, doc } = window.firebaseModules;
                await updateDoc(doc(window.db, 'products', id), productData);
                await loadProducts();
                closeModal('editProductModal');
                alert('Product updated successfully!');
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Failed to update product');
            }
        }

        async function deleteProduct(id) {
            const product = DB.products.find(p => p.id === id);
            if (!product) return;

            if (!confirm(`Delete product "${product.name}"? This action cannot be undone.`)) return;

            try {
                const { deleteDoc, doc } = window.firebaseModules;
                await deleteDoc(doc(window.db, 'products', id));
                await loadProducts();
                alert('Product deleted successfully!');
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Failed to delete product');
            }
        }

        // Add event listener for edit form
        document.addEventListener('DOMContentLoaded', function() {
            const editProductForm = document.getElementById('editProductForm');
            if (editProductForm) {
                editProductForm.addEventListener('submit', handleEditProduct);
            }
        });

        function editLocation(id) {
            const location = DB.locations.find(l => l.id === id);
            if (!location) return;

            document.getElementById('editLocationId').value = id;
            document.getElementById('editLocationName').value = location.name;
            document.getElementById('editLocationAddress').value = location.address || '';

            openModal('editLocationModal');
        }

        async function dispatchTransfer(id) {
            if (!hasPermission('dispatch_transfers')) {
                alert('You do not have permission to dispatch transfers');
                return;
            }
            
            const transfer = DB.transfers.find(t => t.id === id);
            if (!transfer) return;
            
            if (!confirm(`Dispatch transfer ${transfer.transfer_id} to ${transfer.to_location}?`)) return;
            
            try {
                const { updateDoc, doc } = window.firebaseModules;
                await updateDoc(doc(window.db, 'transfers', id), {
                    status: 'in_transit',
                    dispatched_at: new Date().toISOString(),
                    dispatched_by: DB.currentUser.email
                });
                await loadTransfers();
                updateDashboard();
                closeModal('transferDetailsModal');
                alert('Transfer dispatched successfully!');
            } catch (error) {
                console.error('Error dispatching transfer:', error);
                alert('Failed to dispatch transfer');
            }
        }
        
        let currentReceivingTransferId = null;

        function updateReceivedQuantity(index, dispatched) {
            const damaged = parseInt(document.querySelector(`.receive-damaged[data-index="${index}"]`).value) || 0;
            const short = parseInt(document.querySelector(`.receive-short[data-index="${index}"]`).value) || 0;
            const received = dispatched - damaged - short;
            document.querySelector(`.received-qty[data-index="${index}"]`).textContent = received;
        }

        async function receiveTransfer(id) {
            if (!hasPermission('receive_transfers')) {
                alert('You do not have permission to receive transfers');
                return;
            }
            
            const transfer = DB.transfers.find(t => t.id === id);
            if (!transfer) return;
            
            // Store the transfer ID for later confirmation
            currentReceivingTransferId = id;
            
            // Build the items list for confirmation
            const itemsHtml = `
                <table class="w-full border">
                    <thead>
                        <tr class="bg-gray-800 text-white">
                            <th class="p-2 text-left">Product</th>
                            <th class="p-2 text-center">Dispatched</th>
                            <th class="p-2 text-center">Product Type</th>
                            <th class="p-2 text-center">Damaged</th>
                            <th class="p-2 text-center">Short</th>
                            <th class="p-2 text-center">Received</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transfer.items.map((item, index) => `
                            <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                                <td class="p-2 border">${item.name} (${item.code})</td>
                                <td class="p-2 border text-center font-bold">${item.quantity_sent}</td>
                                <td class="p-2 border text-center">${item.product_type || item.unit}</td>
                                <td class="p-2 border text-center">
                                    <input type="number" class="receive-damaged" data-index="${index}" 
                                           min="0" max="${item.quantity_sent}" value="0" 
                                           onchange="updateReceivedQuantity(${index}, ${item.quantity_sent})"
                                           style="width: 80px; text-align: center;">
                                </td>
                                <td class="p-2 border text-center">
                                    <input type="number" class="receive-short" data-index="${index}" 
                                           min="0" max="${item.quantity_sent}" value="0"
                                           onchange="updateReceivedQuantity(${index}, ${item.quantity_sent})"
                                           style="width: 80px; text-align: center;">
                                </td>
                                <td class="p-2 border text-center font-bold received-qty" data-index="${index}">${item.quantity_sent}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('receiveItemsList').innerHTML = itemsHtml;
            document.getElementById('receiveConfirmationModal').classList.remove('hidden');
        }
        
        async function confirmReceiveTransfer() {
            if (!currentReceivingTransferId) return;
            
            const transfer = DB.transfers.find(t => t.id === currentReceivingTransferId);
            if (!transfer) return;
            
            // Collect all the quantities
            const updatedItems = transfer.items.map((item, index) => {
                const qtySent = item.quantity_sent || 0;
                const qtyDamaged = parseInt(document.querySelector(`.receive-damaged[data-index="${index}"]`).value) || 0;
                const qtyShort = parseInt(document.querySelector(`.receive-short[data-index="${index}"]`).value) || 0;
                const qtyReceived = qtySent - qtyDamaged - qtyShort;
                
                return {
                    ...item,
                    quantity_received: qtyReceived,
                    quantity_damaged: qtyDamaged,
                    quantity_short: qtyShort
                };
            });
            
            // Check if there are any damaged or short items
            const hasDamaged = updatedItems.some(item => item.quantity_damaged > 0);
            const hasShort = updatedItems.some(item => item.quantity_short > 0);
            
            if (hasDamaged || hasShort) {
                const confirmMsg = 'You have noted damaged or short items. Are you sure you want to confirm receipt?';
                if (!confirm(confirmMsg)) return;
            }
            
            try {
                const { updateDoc, doc } = window.firebaseModules;
                
                await updateDoc(doc(window.db, 'transfers', currentReceivingTransferId), {
                    status: 'received',
                    received_at: new Date().toISOString(),
                    received_by: DB.currentUser.email,
                    items: updatedItems
                });
                
                await loadTransfers();
                updateDashboard();
                closeModal('receiveConfirmationModal');
                closeModal('transferDetailsModal');
                currentReceivingTransferId = null;
                alert('Transfer received successfully!');
            } catch (error) {
                console.error('Error receiving transfer:', error);
                alert('Failed to receive transfer');
            }
        }

        // ============================================
        // RETURNS MANAGEMENT FUNCTIONS
        // ============================================

        function showLogReturnModal() {
            // Populate products dropdown
            const productSelect = document.getElementById('returnProduct');
            productSelect.innerHTML = '<option value="">Select Product...</option>' +
                DB.products.map(p => `<option value="${p.id}" data-unit="${p.unit}">${p.name}</option>`).join('');
            
            // Populate locations dropdown
            const locationSelect = document.getElementById('returnLocation');
            locationSelect.innerHTML = '<option value="">Select Location...</option>' +
                DB.locations.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
            
            // Populate transfers dropdown (received transfers only)
            const transferSelect = document.getElementById('returnTransferId');
            const receivedTransfers = DB.transfers.filter(t => t.status === 'received');
            transferSelect.innerHTML = '<option value="">Select Transfer...</option>' +
                receivedTransfers.map(t => `<option value="${t.id}">${t.transfer_id} - ${t.from_location} ‚Üí ${t.to_location}</option>`).join('');
            
            document.getElementById('logReturnForm').reset();
            document.getElementById('transferSelectDiv').classList.add('hidden');
            openModal('logReturnModal');
        }

        function handleReturnTypeChange() {
            const returnType = document.getElementById('returnType').value;
            const transferDiv = document.getElementById('transferSelectDiv');
            
            if (returnType === 'transfer') {
                transferDiv.classList.remove('hidden');
            } else {
                transferDiv.classList.add('hidden');
            }
        }
        
        function handleReturnTransferChange() {
            const transferId = document.getElementById('returnTransferId').value;
            if (!transferId) return;
            
            const transfer = DB.transfers.find(t => t.id === transferId);
            if (!transfer) return;
            
            // Update product list to show only items from this transfer
            const productSelect = document.getElementById('returnProduct');
            const transferItems = transfer.items || [];
            productSelect.innerHTML = '<option value="">Select Product from Transfer...</option>' +
                transferItems.map(item => `<option value="${item.product_id}" data-unit="${item.unit}" data-quantity="${item.quantity_sent}">${item.name} (${item.quantity_sent} available)</option>`).join('');
        }

        // Update unit when product is selected
        function initializeReturnFormListeners() {
            const productSelect = document.getElementById('returnProduct');
            if (productSelect) {
                productSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const unit = selectedOption.getAttribute('data-unit') || '';
                    document.getElementById('returnUnit').value = unit;
                });
            }
            
            const logReturnForm = document.getElementById('logReturnForm');
            if (logReturnForm) {
                logReturnForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const returnType = document.getElementById('returnType').value;
                    const transferId = document.getElementById('returnTransferId').value;
                    const productId = document.getElementById('returnProduct').value;
                    const quantity = parseInt(document.getElementById('returnQuantity').value);
                    const unit = document.getElementById('returnUnit').value;
                    const reason = document.getElementById('returnReason').value;
                    const notes = document.getElementById('returnNotes').value;
                    const location = document.getElementById('returnLocation').value;
                    
                    // Get product name
                    const product = DB.products.find(p => p.id === productId);
                    if (!product) {
                        alert('Product not found');
                        return;
                    }
                    
                    // Validate return quantity if from transfer
                    if (returnType === 'transfer' && transferId) {
                        const transfer = DB.transfers.find(t => t.id === transferId);
                        if (!transfer) {
                            alert('Transfer not found');
                            return;
                        }
                        
                        const transferItem = transfer.items.find(i => i.product_id === productId);
                        if (!transferItem) {
                            alert('This product was not in the selected transfer');
                            return;
                        }
                        
                        const availableQty = (transferItem.quantity_sent || 0) - (transferItem.quantity_received || 0);
                        if (quantity > availableQty || quantity <= 0) {
                            alert(`Cannot return ${quantity}. Available quantity: ${availableQty}`);
                            return;
                        }
                    } else if (quantity <= 0) {
                        alert('Quantity must be greater than 0');
                        return;
                    }
                    
                    // Generate return ID
                    const returnId = 'RET' + Date.now().toString().slice(-8);
                    
                    const returnData = {
                        return_id: returnId,
                        return_type: returnType,
                        transfer_id: transferId || null,
                        product_id: productId,
                        product_name: product.name,
                        quantity: quantity,
                        unit: unit,
                        reason: reason,
                        notes: notes,
                        location: location,
                        created_at: new Date().toISOString(),
                        created_by: DB.currentUser.email,
                        created_by_name: DB.currentUser.name || DB.currentUser.email.split('@')[0]
                    };
                    
                    try {
                        const { addDoc, collection } = window.firebaseModules;
                        await addDoc(collection(window.db, 'returns'), returnData);
                        
                        await loadReturns();
                        closeModal('logReturnModal');
                        alert('Return logged successfully!');
                    } catch (error) {
                        console.error('Error logging return:', error);
                        alert('Failed to log return: ' + error.message);
                    }
                });
            }
        }

        function renderReturns() {
            const searchTerm = document.getElementById('searchReturns').value.toLowerCase();
            const filterMonth = document.getElementById('filterReturnMonth').value;
            const filterDate = document.getElementById('filterReturnDate').value;
            
            let filtered = DB.returns;
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(r => 
                    r.return_id.toLowerCase().includes(searchTerm) ||
                    (r.transfer_id && r.transfer_id.toLowerCase().includes(searchTerm)) ||
                    r.product_name.toLowerCase().includes(searchTerm) ||
                    r.reason.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply specific date filter
            if (filterDate) {
                filtered = filtered.filter(r => {
                    const returnDate = new Date(r.created_at).toISOString().split('T')[0];
                    return returnDate === filterDate;
                });
            }
            
            // Apply month filter
            if (filterMonth) {
                filtered = filtered.filter(r => {
                    const returnDate = new Date(r.created_at);
                    const monthStr = returnDate.getFullYear() + '-' + String(returnDate.getMonth() + 1).padStart(2, '0');
                    return monthStr === filterMonth;
                });
            }
            
            const returnsList = document.getElementById('returnsList');
            
            if (filtered.length === 0) {
                returnsList.innerHTML = '<p class="text-center text-gray-500 py-8">No returns found</p>';
                return;
            }
            
            const html = `
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Return ID</th>
                                <th>Transfer ID</th>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Reason</th>
                                <th>Location</th>
                                <th>Date</th>
                                <th>By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(r => `
                                <tr>
                                    <td><span class="badge badge-blue">${r.return_id}</span></td>
                                    <td>${r.transfer_id ? `<span class="badge badge-gray">${r.transfer_id}</span>` : '-'}</td>
                                    <td>${r.product_name}</td>
                                    <td>${r.quantity} ${r.unit}</td>
                                    <td><span class="badge badge-${getReasonBadgeColor(r.reason)}">${r.reason.replace('_', ' ')}</span></td>
                                    <td>${r.location}</td>
                                    <td>${new Date(r.created_at).toLocaleDateString()}</td>
                                    <td>${r.created_by_name || r.created_by}</td>
                                    <td>
                                        <button onclick="viewReturnDetails('${r.id}')" class="btn-icon" title="View Details">üëÅÔ∏è</button>
                                        <button onclick="printReturn('${r.id}')" class="btn-icon" title="Print">üñ®Ô∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            returnsList.innerHTML = html;
        }

        function getReasonBadgeColor(reason) {
            const colors = {
                'damaged': 'red',
                'expired': 'orange',
                'quality_issue': 'orange',
                'wrong_product': 'blue',
                'customer_return': 'gray',
                'overstocked': 'green',
                'other': 'gray'
            };
            return colors[reason] || 'gray';
        }

        function printReturn(returnId) {
            const returnItem = DB.returns.find(r => r.id === returnId);
            if (!returnItem) return;
            
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = `
                <div class="print-document">
                    <div class="print-header">
                        <div class="print-header-left">
                            <h1 class="print-company-name">FAIRFIELD MEAT CENTRE</h1>
                            <p class="print-subtitle">Product Return Report</p>
                        </div>
                        <div class="print-header-right">
                            <div class="print-transfer-id">${returnItem.return_id}</div>
                        </div>
                    </div>
                    
                    <div class="print-info-grid">
                        <div class="print-section">
                            <div class="print-section-title">Return Details</div>
                            <div class="print-info-row">
                                <span class="print-info-label">Return ID:</span>
                                <span>${returnItem.return_id}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Date:</span>
                                <span>${formatDate(returnItem.created_at)}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Type:</span>
                                <span>${returnItem.return_type === 'transfer' ? 'From Transfer' : 'Standalone'}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Location:</span>
                                <span>${returnItem.location}</span>
                            </div>
                        </div>
                        <div class="print-section">
                            <div class="print-section-title">Product Info</div>
                            <div class="print-info-row">
                                <span class="print-info-label">Product:</span>
                                <span>${returnItem.product_name}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Quantity:</span>
                                <span>${returnItem.quantity} ${returnItem.unit}</span>
                            </div>
                            <div class="print-info-row">
                                <span class="print-info-label">Reason:</span>
                                <span>${returnItem.reason.replace('_', ' ')}</span>
                            </div>
                            ${returnItem.transfer_id ? `<div class="print-info-row">
                                <span class="print-info-label">Transfer:</span>
                                <span>${returnItem.transfer_id}</span>
                            </div>` : ''}
                        </div>
                    </div>
                    
                    ${returnItem.notes ? `<div class="print-section" style="margin-top: 6px;">
                        <div class="print-section-title">Notes</div>
                        <div style="font-size: 8pt; padding: 4px; white-space: pre-wrap;">${returnItem.notes}</div>
                    </div>` : ''}
                </div>
            `;
            
            printArea.style.display = 'block';
            setTimeout(() => {
                window.print();
                setTimeout(() => {
                    printArea.style.display = 'none';
                }, 500);
            }, 100);
        }
        
        function viewReturnDetails(returnId) {
            const returnItem = DB.returns.find(r => r.id === returnId);
            if (!returnItem) return;
            
            const html = `
                <div class="space-y-4">
                    <div class="grid-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600">Return ID</label>
                            <p class="font-semibold">${returnItem.return_id}</p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Type</label>
                            <p class="font-semibold">${returnItem.return_type === 'transfer' ? 'From Transfer' : 'Standalone'}</p>
                        </div>
                    </div>
                    
                    ${returnItem.transfer_id ? `
                        <div>
                            <label class="text-sm text-gray-600">Transfer ID</label>
                            <p class="font-semibold">${returnItem.transfer_id}</p>
                        </div>
                    ` : ''}
                    
                    <div class="grid-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600">Product</label>
                            <p class="font-semibold">${returnItem.product_name}</p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Quantity</label>
                            <p class="font-semibold">${returnItem.quantity} ${returnItem.unit}</p>
                        </div>
                    </div>
                    
                    <div class="grid-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600">Reason</label>
                            <p class="font-semibold">${returnItem.reason.replace('_', ' ')}</p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Location</label>
                            <p class="font-semibold">${returnItem.location}</p>
                        </div>
                    </div>
                    
                    ${returnItem.notes ? `
                        <div>
                            <label class="text-sm text-gray-600">Notes</label>
                            <p class="font-semibold">${returnItem.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="grid-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600">Created Date</label>
                            <p class="font-semibold">${new Date(returnItem.created_at).toLocaleString()}</p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Created By</label>
                            <p class="font-semibold">${returnItem.created_by_name || returnItem.created_by}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('transferDetailsContent').innerHTML = html;
            openModal('transferDetailsModal');
        }

        function updateReturnsStats() {
            // Total returns
            document.getElementById('statTotalReturns').textContent = DB.returns.length;
            
            // This month returns
            const now = new Date();
            const thisMonthReturns = DB.returns.filter(r => {
                const returnDate = new Date(r.created_at);
                return returnDate.getMonth() === now.getMonth() && 
                       returnDate.getFullYear() === now.getFullYear();
            });
            document.getElementById('statMonthReturns').textContent = thisMonthReturns.length;
            
            // Total items returned
            const totalItems = DB.returns.reduce((sum, r) => sum + r.quantity, 0);
            document.getElementById('statReturnItems').textContent = totalItems;
            
            // Populate month filter
            populateReturnMonthFilter();
        }

        function populateReturnMonthFilter() {
            const filterMonth = document.getElementById('filterReturnMonth');
            if (!filterMonth) return;
            
            const months = new Set();
            DB.returns.forEach(r => {
                const date = new Date(r.created_at);
                const monthStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                months.add(monthStr);
            });
            
            const sortedMonths = Array.from(months).sort().reverse();
            filterMonth.innerHTML = '<option value="">All Time</option>' +
                sortedMonths.map(m => {
                    const date = new Date(m + '-01');
                    const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    return `<option value="${m}">${monthName}</option>`;
                }).join('');
        }
    </script>
</body>
</html>
